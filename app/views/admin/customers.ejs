<!-- Admin Customers List -->

<!-- Page Header -->
<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
    <div>
        <h1 class="text-2xl font-bold text-slate-900">
            <%= t('admin.customers.title', 'العملاء' ) %>
        </h1>
        <p class="text-slate-500 mt-1">
            <%= t('admin.customers.subtitle', 'إدارة ومتابعة عملاء المتجر' ) %>
        </p>
    </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
    <div class="bg-white rounded-xl border border-gray-100 p-4">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                <span class="material-symbols-outlined text-blue-600">group</span>
            </div>
            <div>
                <p class="text-sm text-slate-500">
                    <%= t('admin.customers.stats.total', 'إجمالي العملاء' ) %>
                </p>
                <p id="total-customers" class="text-xl font-bold text-slate-900">---</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl border border-gray-100 p-4">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                <span class="material-symbols-outlined text-green-600">verified</span>
            </div>
            <div>
                <p class="text-sm text-slate-500">
                    <%= t('admin.customers.stats.verified', 'عملاء مفعّلين' ) %>
                </p>
                <p id="verified-customers" class="text-xl font-bold text-slate-900">---</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl border border-gray-100 p-4">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center">
                <span class="material-symbols-outlined text-amber-600">person_add</span>
            </div>
            <div>
                <p class="text-sm text-slate-500">
                    <%= t('admin.customers.stats.new', 'عملاء جدد (هذا الشهر)' ) %>
                </p>
                <p id="new-customers" class="text-xl font-bold text-slate-900">---</p>
            </div>
        </div>
    </div>
</div>

<!-- Search -->
<div class="bg-white rounded-xl border border-gray-100 p-4 mb-6">
    <div class="flex flex-wrap items-center gap-4">
        <div class="flex-1 min-w-[200px] relative">
            <span
                class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
            <input type="text" id="search-input"
                placeholder="<%= t('admin.customers.searchPlaceholder', 'بحث بالاسم أو البريد أو الهاتف...') %>"
                class="w-full h-10 pr-10 pl-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
        </div>
        <select id="status-filter"
            class="h-10 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
            <option value="">
                <%= t('admin.customers.filter.all', 'جميع الحالات' ) %>
            </option>
            <option value="verified">
                <%= t('admin.customers.filter.verified', 'مفعّل' ) %>
            </option>
            <option value="unverified">
                <%= t('admin.customers.filter.unverified', 'غير مفعّل' ) %>
            </option>
        </select>
    </div>
</div>

<!-- Customers Table -->
<div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-50 text-slate-500">
                <tr>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.customers.table.customer', 'العميل' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.customers.table.phone', 'الهاتف' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.customers.table.orders', 'الطلبات' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.customers.table.totalSpent', 'إجمالي المشتريات' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.customers.table.status', 'الحالة' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.customers.table.date', 'تاريخ التسجيل' ) %>
                    </th>
                    <th class="text-center px-6 py-4 font-medium">
                        <%= t('admin.customers.table.actions', 'الإجراءات' ) %>
                    </th>
                </tr>
            </thead>
            <tbody id="customers-table" class="divide-y divide-gray-50">
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-slate-400">
                        <%= t('admin.customers.messages.loading', 'جاري التحميل...' ) %>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex items-center justify-between px-6 py-4 border-t border-gray-100">
        <p class="text-sm text-slate-500">
            <%= t('common.showing', 'عرض' ) %> <span id="showing-from">0</span>-<span id="showing-to">0</span>
                <%= t('common.from', 'من' ) %> <span id="total-count">0</span>
        </p>
        <div class="flex items-center gap-2">
            <button id="prev-page"
                class="h-9 px-3 rounded-lg border border-gray-200 text-slate-600 hover:bg-gray-50 disabled:opacity-50 text-sm">
                <%= t('common.previous', 'السابق' ) %>
            </button>
            <button id="next-page"
                class="h-9 px-3 rounded-lg border border-gray-200 text-slate-600 hover:bg-gray-50 disabled:opacity-50 text-sm">
                <%= t('common.next', 'التالي' ) %>
            </button>
        </div>
    </div>
</div>

<!-- Customer Detail Modal -->
<div id="customer-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-lg w-full p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-bold text-slate-900">
                <%= t('admin.customers.modal.title', 'تفاصيل العميل' ) %>
            </h3>
            <button id="close-modal" class="p-2 rounded-lg hover:bg-gray-100 text-slate-400">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <div id="customer-detail" class="space-y-4">
            <!-- Customer details loaded dynamically -->
        </div>

        <div class="mt-6 pt-4 border-t border-gray-100">
            <a id="view-orders-link" href="#" class="block text-center text-primary font-medium hover:underline">
                <%= t('admin.customers.modal.viewOrders', 'عرض طلبات العميل' ) %> →
            </a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const lang = typeof I18n !== 'undefined' ? I18n.getCurrentLanguage() : 'ar';
        const t = (key, fallback) => typeof I18n !== 'undefined' ? I18n.t(key, fallback) : fallback;

        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/admin/login';
            return;
        }

        let currentPage = 1;
        let currentSearch = '';
        let currentStatus = '';

        // Convert to Arabic numerals
        function toArabicNum(num) {
            if (lang !== 'ar') return num;
            const arabicNums = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return String(num).split('').map(d => arabicNums[parseInt(d)] || d).join('');
        }

        function formatPrice(price) {
            if (lang !== 'ar') {
                return parseFloat(price || 0).toFixed(2) + ' EGP';
            }
            return toArabicNum(parseFloat(price || 0).toFixed(0)) + ' ج.م';
        }

        function formatDate(dateStr) {
            const locale = lang === 'ar' ? 'ar-EG' : 'en-US';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateStr).toLocaleDateString(locale, options);
        }

        // Load customers
        async function loadCustomers() {
            const tbody = document.getElementById('customers-table');
            tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-slate-400">${t('admin.customers.messages.loading', 'جاري التحميل...')}</td></tr>`;

            try {
                const params = new URLSearchParams();
                params.set('page', currentPage);
                params.set('limit', 10);

                const response = await fetch(`/api/admin/customers?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const customers = data.items || data.customers || [];
                    const total = Number.isFinite(data.total) ? data.total : customers.length;
                    const page = Number.isFinite(data.page) ? data.page : currentPage;
                    const limit = Number.isFinite(data.limit) ? data.limit : 10;
                    const totalPages = Math.max(1, Math.ceil(total / limit));
                    const pagination = { total, page, limit, totalPages };

                    document.getElementById('total-customers').textContent = toArabicNum(total || 0);
                    document.getElementById('verified-customers').textContent = toArabicNum(0);
                    document.getElementById('new-customers').textContent = toArabicNum(0);

                    let visibleCustomers = customers;
                    if (currentSearch) {
                        const q = currentSearch.toLowerCase();
                        visibleCustomers = customers.filter((customer) => {
                            return [customer.name, customer.email, customer.phone].some((field) =>
                                String(field || '').toLowerCase().includes(q)
                            );
                        });
                    }

                    if (visibleCustomers.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-slate-400">${t('admin.customers.messages.noCustomers', 'لا يوجد عملاء')}</td></tr>`;
                        return;
                    }

                    tbody.innerHTML = visibleCustomers.map(customer => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold">
                                    ${(customer.name || 'U').charAt(0).toUpperCase()}
                                </div>
                                <div class="min-w-0">
                                    <p class="font-medium text-slate-900">${customer.name || t('admin.customers.messages.noName', 'بدون اسم')}</p>
                                    <p class="text-xs text-slate-500 truncate" dir="ltr">${customer.email}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-slate-600" dir="ltr">${customer.phone || '-'}</td>
                        <td class="px-6 py-4 text-slate-600">${toArabicNum(customer.orders_count || 0)}</td>
                        <td class="px-6 py-4 font-medium text-slate-900">${formatPrice(customer.total_spent || 0)}</td>
                        <td class="px-6 py-4">
                            <span class="px-2.5 py-1 rounded-full bg-gray-100 text-gray-600 text-xs font-medium">—</span>
                        </td>
                        <td class="px-6 py-4 text-slate-500">${customer.last_order_at ? formatDate(customer.last_order_at) : '—'}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center justify-center gap-2">
                                <button class="view-btn p-2 rounded-lg hover:bg-gray-100 text-slate-600" data-customer='${JSON.stringify(customer)}' title="${t('common.view', 'عرض')}">
                                    <span class="material-symbols-outlined text-lg">visibility</span>
                                </button>
                                <a href="/admin/orders?customer=${customer.id}" class="p-2 rounded-lg hover:bg-gray-100 text-slate-600" title="${t('admin.orders.title', 'الطلبات')}">
                                    <span class="material-symbols-outlined text-lg">shopping_bag</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                `).join('');

                    // Update pagination
                    const displayTotal = currentSearch ? visibleCustomers.length : pagination.total;
                    const from = displayTotal === 0 ? 0 : (pagination.page - 1) * pagination.limit + 1;
                    const to = Math.min(from + visibleCustomers.length - 1, displayTotal);

                    document.getElementById('showing-from').textContent = toArabicNum(from);
                    document.getElementById('showing-to').textContent = toArabicNum(to);
                    document.getElementById('total-count').textContent = toArabicNum(displayTotal);

                    const paginationWrapper = document.getElementById('pagination');
                    if (pagination.totalPages <= 1) {
                        paginationWrapper.classList.add('hidden');
                    } else {
                        paginationWrapper.classList.remove('hidden');
                    }

                    document.getElementById('prev-page').disabled = currentPage <= 1;
                    document.getElementById('next-page').disabled = currentPage >= pagination.totalPages;

                    // View buttons
                    document.querySelectorAll('.view-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const customer = JSON.parse(this.dataset.customer);
                            showCustomerModal(customer);
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-red-500">${t('admin.customers.messages.error', 'حدث خطأ في التحميل')}</td></tr>`;
            }
        }

        // Show customer modal
        function showCustomerModal(customer) {
            const detail = document.getElementById('customer-detail');
            detail.innerHTML = `
            <div class="flex items-center gap-4 pb-4 border-b border-gray-100">
                <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center text-primary text-2xl font-bold">
                    ${(customer.name || 'U').charAt(0).toUpperCase()}
                </div>
                <div>
                    <h4 class="font-bold text-slate-900 text-lg">${customer.name || t('admin.customers.messages.noName', 'بدون اسم')}</h4>
                    <p class="text-slate-500 text-sm" dir="ltr">${customer.email}</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 py-4">
                <div>
                    <p class="text-xs text-slate-500 mb-1">${t('admin.customers.table.phone', 'الهاتف')}</p>
                    <p class="text-slate-900" dir="ltr">${customer.phone || '-'}</p>
                </div>
                <div>
                    <p class="text-xs text-slate-500 mb-1">${t('admin.customers.table.date', 'تاريخ التسجيل')}</p>
                    <p class="text-slate-900">${formatDate(customer.created_at)}</p>
                </div>
                <div>
                    <p class="text-xs text-slate-500 mb-1">${t('admin.customers.stats.orders', 'عدد الطلبات')}</p>
                    <p class="text-slate-900">${toArabicNum(customer.orders_count || 0)}</p>
                </div>
                <div>
                    <p class="text-xs text-slate-500 mb-1">${t('admin.customers.table.totalSpent', 'إجمالي المشتريات')}</p>
                    <p class="text-slate-900 font-bold text-primary">${formatPrice(customer.total_spent || 0)}</p>
                </div>
            </div>
        `;

            document.getElementById('view-orders-link').href = `/admin/orders?customer=${customer.id}`;
            document.getElementById('customer-modal').classList.remove('hidden');
        }

        // Close modal
        document.getElementById('close-modal').addEventListener('click', function () {
            document.getElementById('customer-modal').classList.add('hidden');
        });

        // Search
        document.getElementById('search-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                currentSearch = this.value;
                currentPage = 1;
                loadCustomers();
            }
        });

        // Status filter
        document.getElementById('status-filter').addEventListener('change', function () {
            currentStatus = this.value;
            currentPage = 1;
            loadCustomers();
        });

        // Pagination
        document.getElementById('prev-page').addEventListener('click', function () {
            if (currentPage > 1) { currentPage--; loadCustomers(); }
        });

        document.getElementById('next-page').addEventListener('click', function () {
            currentPage++;
            loadCustomers();
        });

        // Initialize
        loadCustomers();
    });
</script>
