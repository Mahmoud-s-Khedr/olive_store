<!-- Admin Product Form (Add/Edit) -->

<!-- Page Header -->
<div class="mb-8">
    <nav class="flex items-center gap-2 text-sm text-slate-500 mb-4">
        <a href="/admin" class="hover:text-primary">
            <%= t('admin.menu.dashboard', 'لوحة التحكم' ) %>
        </a>
        <span>/</span>
        <a href="/admin/products" class="hover:text-primary">
            <%= t('admin.menu.products', 'المنتجات' ) %>
        </a>
        <span>/</span>
        <span id="breadcrumb-current" class="text-slate-700">
            <%= t('admin.productForm.breadcrumbNew', 'منتج جديد' ) %>
        </span>
    </nav>
    <h1 id="page-title" class="text-2xl font-bold text-slate-900">
        <%= t('admin.productForm.titleNew', 'إضافة منتج جديد' ) %>
    </h1>
</div>

<form id="product-form" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <input type="hidden" id="product-id">

    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">

        <!-- Basic Info -->
        <div class="bg-white rounded-xl border border-gray-100 p-6">
            <h2 class="font-bold text-slate-900 mb-5">
                <%= t('admin.productForm.sections.basic', 'المعلومات الأساسية' ) %>
            </h2>

            <div class="space-y-5">
                <!-- Arabic Name -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.nameAr', 'اسم المنتج بالعربية' ) %> <span
                                class="text-red-500">*</span>
                    </label>
                    <input type="text" id="name-ar" name="name_ar" required
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm rtl:text-right ltr:text-left">
                </div>

                <!-- English Name -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.nameEn', 'اسم المنتج بالإنجليزية' ) %>
                    </label>
                    <input type="text" id="name-en" name="name_en" dir="ltr"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                </div>

                <!-- Slug -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.slug', 'Slug' ) %>
                    </label>
                    <input type="text" id="slug" name="slug" dir="ltr"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm bg-gray-50"
                        placeholder="<%= t('admin.productForm.placeholders.slugAuto', 'auto-generated') %>">
                </div>

                <!-- Short Description -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.shortDesc', 'وصف مختصر' ) %>
                    </label>
                    <textarea id="short-desc-ar" name="short_description_ar" rows="2"
                        class="w-full px-4 py-3 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm rtl:text-right ltr:text-left"
                        placeholder="<%= t('admin.productForm.placeholders.shortDesc', 'وصف مختصر يظهر في قوائم المنتجات') %>"></textarea>
                </div>

                <!-- Full Description -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.fullDesc', 'الوصف الكامل' ) %>
                    </label>
                    <textarea id="desc-ar" name="description_ar" rows="5"
                        class="w-full px-4 py-3 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm rtl:text-right ltr:text-left"
                        placeholder="<%= t('admin.productForm.placeholders.fullDesc', 'وصف تفصيلي للمنتج') %>"></textarea>
                </div>
            </div>
        </div>

        <!-- Images -->
        <div class="bg-white rounded-xl border border-gray-100 p-6">
            <h2 class="font-bold text-slate-900 mb-5">
                <%= t('admin.productForm.sections.images', 'الصور' ) %>
            </h2>

            <div class="space-y-4">
                <!-- Primary Image -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.primaryImage', 'الصورة الرئيسية' ) %> <span
                                class="text-red-500">*</span>
                    </label>
                    <input type="url" id="primary-image" name="primary_image" dir="ltr" required
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm"
                        placeholder="<%= t('admin.productForm.placeholders.url', 'https://...') %>">
                </div>

                <!-- Image Preview -->
                <div id="image-preview" class="hidden w-32 h-32 rounded-lg border border-gray-200 overflow-hidden">
                    <img id="preview-img" src="" alt="" class="w-full h-full object-cover">
                </div>

                <!-- Additional Images -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.additionalImages', 'صور إضافية (سطر لكل رابط)' ) %>
                    </label>
                    <textarea id="additional-images" name="images" rows="3" dir="ltr"
                        class="w-full px-4 py-3 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm font-mono text-xs"
                        placeholder="<%= t('admin.productForm.placeholders.images', 'https://image1.jpg\nhttps://image2.jpg') %>"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="lg:col-span-1 space-y-6">

        <!-- Publish -->
        <div class="bg-white rounded-xl border border-gray-100 p-6">
            <h2 class="font-bold text-slate-900 mb-5">
                <%= t('admin.productForm.sections.publish', 'النشر' ) %>
            </h2>

            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="is-active" name="is_active" checked
                        class="rounded border-gray-300 text-primary focus:ring-primary">
                    <label for="is-active" class="text-sm text-slate-700">
                        <%= t('admin.productForm.fields.isActive', 'منتج نشط' ) %>
                    </label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="is-featured" name="is_featured"
                        class="rounded border-gray-300 text-primary focus:ring-primary">
                    <label for="is-featured" class="text-sm text-slate-700">
                        <%= t('admin.productForm.fields.isFeatured', 'منتج مميز' ) %>
                    </label>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="is-new" name="is_new"
                        class="rounded border-gray-300 text-primary focus:ring-primary">
                    <label for="is-new" class="text-sm text-slate-700">
                        <%= t('admin.productForm.fields.isNew', 'منتج جديد' ) %>
                    </label>
                </div>
            </div>

            <!-- Error -->
            <div id="form-error"
                class="hidden mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>

            <div class="mt-6 flex gap-3">
                <a href="/admin/products"
                    class="flex-1 h-11 border border-gray-200 rounded-lg font-medium hover:bg-gray-50 transition-colors flex items-center justify-center">
                    <%= t('admin.productForm.buttons.cancel', 'إلغاء' ) %>
                </a>
                <button type="submit" id="submit-btn"
                    class="flex-1 h-11 bg-primary hover:bg-primary-dark text-white rounded-lg font-bold transition-colors flex items-center justify-center gap-2">
                    <span id="submit-text">
                        <%= t('admin.productForm.buttons.save', 'حفظ' ) %>
                    </span>
                    <span id="submit-spinner" class="spinner hidden"></span>
                </button>
            </div>
        </div>

        <!-- Category -->
        <div class="bg-white rounded-xl border border-gray-100 p-6">
            <h2 class="font-bold text-slate-900 mb-5">
                <%= t('admin.productForm.sections.category', 'الفئة' ) %>
            </h2>
            <select id="category" name="category_id"
                class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm rtl:text-right ltr:text-left">
                <option value="">
                    <%= t('admin.productForm.fields.noCategory', 'بدون فئة' ) %>
                </option>
            </select>
        </div>

        <!-- Pricing -->
        <div class="bg-white rounded-xl border border-gray-100 p-6">
            <h2 class="font-bold text-slate-900 mb-5">
                <%= t('admin.productForm.sections.pricing', 'التسعير' ) %>
            </h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.price', 'السعر (ج.م)' ) %> <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="price" name="price" required min="0" step="0.01"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.oldPrice', 'السعر القديم (للخصم)' ) %>
                    </label>
                    <input type="number" id="old-price" name="old_price" min="0" step="0.01"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                </div>
            </div>
        </div>

        <!-- Inventory -->
        <div class="bg-white rounded-xl border border-gray-100 p-6">
            <h2 class="font-bold text-slate-900 mb-5">
                <%= t('admin.productForm.sections.inventory', 'المخزون' ) %>
            </h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.stock', 'الكمية' ) %> <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="stock" name="stock" required min="0"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.sku', 'SKU' ) %>
                    </label>
                    <input type="text" id="sku" name="sku" dir="ltr"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                </div>
            </div>
        </div>

        <!-- Shipping -->
        <div class="bg-white rounded-xl border border-gray-100 p-6">
            <h2 class="font-bold text-slate-900 mb-5">
                <%= t('admin.productForm.sections.shipping', 'الشحن' ) %>
            </h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.weight', 'الوزن (كجم)' ) %>
                    </label>
                    <input type="text" id="weight" name="weight"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.productForm.fields.dimensions', 'الأبعاد' ) %>
                    </label>
                    <input type="text" id="dimensions" name="dimensions"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm rtl:text-right ltr:text-left"
                        placeholder="<%= t('admin.productForm.placeholders.dimensions', 'الطول × العرض × الارتفاع') %>">
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const lang = typeof I18n !== 'undefined' ? I18n.getCurrentLanguage() : 'ar';
        const t = (key, fallback) => typeof I18n !== 'undefined' ? I18n.t(key, fallback) : fallback;

        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/admin/login';
            return;
        }

        // Check if editing
        const pathParts = window.location.pathname.split('/');
        const isEdit = pathParts.includes('edit');
        const productId = isEdit ? pathParts[pathParts.indexOf('products') + 1] : null;

        // Update page title for edit mode
        if (isEdit) {
            document.getElementById('page-title').textContent = t('admin.productForm.titleEdit', 'تعديل المنتج');
            document.getElementById('breadcrumb-current').textContent = t('admin.productForm.breadcrumbEdit', 'تعديل');
            document.getElementById('product-id').value = productId;
        }

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('category');
                    data.categories?.forEach(cat => {
                        const name = lang === 'ar' ? cat.name_ar : (cat.name_en || cat.name_ar);
                        select.innerHTML += `<option value="${cat.id}">${name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load product if editing
        async function loadProduct() {
            if (!productId) return;

            try {
                const response = await fetch(`/api/admin/products/${productId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const product = data.product || data;

                    document.getElementById('name-ar').value = product.name_ar || '';
                    document.getElementById('name-en').value = product.name_en || '';
                    document.getElementById('slug').value = product.slug || '';
                    document.getElementById('short-desc-ar').value = product.short_description_ar || '';
                    document.getElementById('desc-ar').value = product.description_ar || '';
                    document.getElementById('primary-image').value = '';
                    document.getElementById('category').value = product.category_id || '';
                    document.getElementById('price').value = product.price || '';
                    document.getElementById('old-price').value = product.old_price || '';
                    document.getElementById('stock').value = product.stock || 0;
                    document.getElementById('sku').value = product.sku || '';
                    document.getElementById('weight').value = product.weight || '';
                    document.getElementById('dimensions').value = product.dimensions || '';
                    document.getElementById('is-active').checked = product.is_active !== false;
                    document.getElementById('is-featured').checked = product.is_featured === true;
                    document.getElementById('is-new').checked = product.is_new === true;

                    document.getElementById('image-preview').classList.add('hidden');
                    document.getElementById('additional-images').value = '';
                }
            } catch (error) {
                console.error('Error loading product:', error);
            }
        }

        // Image preview
        document.getElementById('primary-image').addEventListener('blur', function () {
            if (this.value) {
                document.getElementById('preview-img').src = this.value;
                document.getElementById('image-preview').classList.remove('hidden');
            } else {
                document.getElementById('image-preview').classList.add('hidden');
            }
        });

        // Form submission
        document.getElementById('product-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formError = document.getElementById('form-error');
            const submitBtn = document.getElementById('submit-btn');
            const submitText = document.getElementById('submit-text');
            const submitSpinner = document.getElementById('submit-spinner');

            formError.classList.add('hidden');
            submitBtn.disabled = true;
            submitText.textContent = t('admin.productForm.buttons.saving', 'جاري الحفظ...');
            submitSpinner.classList.remove('hidden');

            const data = {
                name_ar: document.getElementById('name-ar').value,
                name_en: document.getElementById('name-en').value || undefined,
                slug: document.getElementById('slug').value || undefined,
                short_description_ar: document.getElementById('short-desc-ar').value || undefined,
                description_ar: document.getElementById('desc-ar').value || undefined,
                category_id: document.getElementById('category').value || null,
                price: parseFloat(document.getElementById('price').value),
                old_price: document.getElementById('old-price').value ? parseFloat(document.getElementById('old-price').value) : null,
                stock: parseInt(document.getElementById('stock').value),
                sku: document.getElementById('sku').value || undefined,
                weight: document.getElementById('weight').value || undefined,
                dimensions: document.getElementById('dimensions').value || undefined,
                is_active: document.getElementById('is-active').checked,
                is_featured: document.getElementById('is-featured').checked,
                is_new: document.getElementById('is-new').checked
            };

            try {
                const url = isEdit ? `/api/admin/products/${productId}` : '/api/admin/products';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    window.location.href = '/admin/products';
                } else {
                    const result = await response.json();
                    formError.textContent = result.message || t('admin.productForm.messages.saveError', 'حدث خطأ أثناء الحفظ');
                    formError.classList.remove('hidden');
                }
            } catch (error) {
                formError.textContent = t('admin.productForm.messages.connectionError', 'حدث خطأ في الاتصال');
                formError.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitText.textContent = t('admin.productForm.buttons.save', 'حفظ');
                submitSpinner.classList.add('hidden');
            }
        });

        // Initialize
        await loadCategories();
        if (isEdit) {
            await loadProduct();
        }
    });
</script>
