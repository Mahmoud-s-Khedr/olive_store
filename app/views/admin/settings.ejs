<!-- Admin Settings -->

<!-- Page Header -->
<div class="mb-8">
    <h1 class="text-2xl font-bold text-slate-900">
        <%= t('admin.settings.title', 'الإعدادات' ) %>
    </h1>
    <p class="text-slate-500 mt-1">
        <%= t('admin.settings.subtitle', 'إعدادات المتجر والنظام' ) %>
    </p>
</div>

<!-- Settings Tabs -->
<div class="flex flex-wrap gap-2 mb-6">
    <button class="settings-tab active px-4 py-2 rounded-lg bg-primary text-white text-sm font-medium"
        data-tab="general">
        <%= t('admin.settings.tabs.general', 'عام' ) %>
    </button>
    <button
        class="settings-tab px-4 py-2 rounded-lg bg-white border border-gray-200 text-slate-600 text-sm font-medium hover:border-primary"
        data-tab="shipping">
        <%= t('admin.settings.tabs.shipping', 'الشحن' ) %>
    </button>
    <button
        class="settings-tab px-4 py-2 rounded-lg bg-white border border-gray-200 text-slate-600 text-sm font-medium hover:border-primary"
        data-tab="payment">
        <%= t('admin.settings.tabs.payment', 'الدفع' ) %>
    </button>
    <button
        class="settings-tab px-4 py-2 rounded-lg bg-white border border-gray-200 text-slate-600 text-sm font-medium hover:border-primary"
        data-tab="notifications">
        <%= t('admin.settings.tabs.notifications', 'الإشعارات' ) %>
    </button>
</div>

<!-- General Settings -->
<div id="tab-general" class="tab-content space-y-6">
    <div class="bg-white rounded-xl border border-gray-100 p-6">
        <h2 class="font-bold text-slate-900 mb-6">
            <%= t('admin.settings.general.info', 'معلومات المتجر' ) %>
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    <%= t('admin.settings.general.nameAr', 'اسم المتجر بالعربية' ) %>
                </label>
                <input type="text" id="store-name-ar" value="زيتون مصر" data-setting-key="store_name_ar" data-setting-type="string"
                    class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    <%= t('admin.settings.general.nameEn', 'اسم المتجر بالإنجليزية' ) %>
                </label>
                <input type="text" id="store-name-en" value="Zaytoun Masr" dir="ltr" data-setting-key="store_name_en" data-setting-type="string"
                    class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    <%= t('admin.settings.general.email', 'البريد الإلكتروني' ) %>
                </label>
                <input type="email" id="store-email" value="info@zaytounmasr.com" dir="ltr" data-setting-key="store_email" data-setting-type="string"
                    class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    <%= t('admin.settings.general.phone', 'رقم الهاتف' ) %>
                </label>
                <input type="tel" id="store-phone" value="+201234567890" dir="ltr" data-setting-key="store_phone" data-setting-type="string"
                    class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    <%= t('admin.settings.general.address', 'العنوان' ) %>
                </label>
                <input type="text" id="store-address" value="القاهرة، مصر الجديدة، شارع النزهة" data-setting-key="store_address_ar" data-setting-type="string"
                    class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    <%= t('admin.settings.general.description', 'وصف المتجر' ) %>
                </label>
                <textarea id="store-description" rows="3" data-setting-key="store_description" data-setting-type="string"
                    class="w-full px-4 py-3 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">أفضل زيوت الزيتون المصرية الطبيعية من واحة سيوة</textarea>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl border border-gray-100 p-6">
        <h2 class="font-bold text-slate-900 mb-6">
            <%= t('admin.settings.general.social', 'الشبكات الاجتماعية' ) %>
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Facebook</label>
                <input type="url" id="social-facebook" placeholder="https://facebook.com/..." dir="ltr" data-setting-key="social_facebook" data-setting-type="string"
                    class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Instagram</label>
                <input type="url" id="social-instagram" placeholder="https://instagram.com/..." dir="ltr" data-setting-key="social_instagram" data-setting-type="string"
                    class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">WhatsApp</label>
                <input type="text" id="social-whatsapp" placeholder="+201234567890" dir="ltr" data-setting-key="social_whatsapp" data-setting-type="string"
                    class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Twitter</label>
                <input type="url" id="social-twitter" placeholder="https://twitter.com/..." dir="ltr" data-setting-key="social_twitter" data-setting-type="string"
                    class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
            </div>
        </div>
    </div>
</div>

<!-- Shipping Settings -->
<div id="tab-shipping" class="tab-content space-y-6 hidden">
    <div class="bg-white rounded-xl border border-gray-100 p-6">
        <h2 class="font-bold text-slate-900 mb-6">
            <%= t('admin.settings.shipping.costs', 'تكاليف الشحن' ) %>
        </h2>

        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.settings.shipping.normal', 'الشحن العادي (ج.م)' ) %>
                    </label>
                    <input type="number" id="shipping-normal" value="50" data-setting-key="shipping_cost" data-setting-type="number"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.settings.shipping.express', 'الشحن السريع (ج.م)' ) %>
                    </label>
                    <input type="number" id="shipping-express" value="100" data-setting-key="shipping_express_cost" data-setting-type="number"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                </div>
            </div>

            <div class="border-t border-gray-100 pt-6">
                <div class="flex items-center gap-2 mb-4">
                    <input type="checkbox" id="free-shipping-enabled" checked data-setting-key="free_shipping_enabled" data-setting-type="boolean"
                        class="rounded border-gray-300 text-primary focus:ring-primary">
                    <label for="free-shipping-enabled" class="text-sm font-medium text-slate-700">
                        <%= t('admin.settings.shipping.enableFree', 'تفعيل الشحن المجاني' ) %>
                    </label>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.settings.shipping.freeMin', 'الحد الأدنى للشحن المجاني (ج.م)' ) %>
                    </label>
                    <input type="number" id="free-shipping-min" value="500" data-setting-key="free_shipping_minimum" data-setting-type="number"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Settings -->
<div id="tab-payment" class="tab-content space-y-6 hidden">
    <div class="bg-white rounded-xl border border-gray-100 p-6">
        <h2 class="font-bold text-slate-900 mb-6">
            <%= t('admin.settings.payment.methods', 'طرق الدفع' ) %>
        </h2>

        <div class="space-y-4">
            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-slate-600">local_shipping</span>
                    <div>
                        <p class="font-medium text-slate-900">
                            <%= t('admin.settings.payment.cod.title', 'الدفع عند الاستلام' ) %>
                        </p>
                        <p class="text-xs text-slate-500">
                            <%= t('admin.settings.payment.cod.desc', 'يدفع العميل نقداً عند استلام الطلب' ) %>
                        </p>
                    </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="payment-cod" checked data-setting-key="payment_cod_enabled" data-setting-type="boolean" class="sr-only peer">
                    <div
                        class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:bg-primary after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-[-20px]">
                    </div>
                </label>
            </div>

            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-slate-600">credit_card</span>
                    <div>
                        <p class="font-medium text-slate-900">
                            <%= t('admin.settings.payment.card.title', 'البطاقات الائتمانية' ) %>
                        </p>
                        <p class="text-xs text-slate-500">
                            <%= t('admin.settings.payment.card.desc', 'Visa, MasterCard, Meeza' ) %>
                        </p>
                    </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="payment-card" data-setting-key="payment_card_enabled" data-setting-type="boolean" class="sr-only peer">
                    <div
                        class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:bg-primary after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-[-20px]">
                    </div>
                </label>
            </div>

            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-slate-600">phone_android</span>
                    <div>
                        <p class="font-medium text-slate-900">
                            <%= t('admin.settings.payment.wallet.title', 'المحافظ الإلكترونية' ) %>
                        </p>
                        <p class="text-xs text-slate-500">
                            <%= t('admin.settings.payment.wallet.desc', 'فودافون كاش، فوري' ) %>
                        </p>
                    </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="payment-wallet" data-setting-key="payment_wallet_enabled" data-setting-type="boolean" class="sr-only peer">
                    <div
                        class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:bg-primary after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-[-20px]">
                    </div>
                </label>
            </div>
        </div>
    </div>
</div>

<!-- Notifications Settings -->
<div id="tab-notifications" class="tab-content space-y-6 hidden">
    <div class="bg-white rounded-xl border border-gray-100 p-6">
        <h2 class="font-bold text-slate-900 mb-6">
            <%= t('admin.settings.notifications.email', 'إشعارات البريد الإلكتروني' ) %>
        </h2>

        <div class="space-y-4">
            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                <div>
                    <p class="font-medium text-slate-900">
                        <%= t('admin.settings.notifications.newOrder.title', 'طلب جديد' ) %>
                    </p>
                    <p class="text-xs text-slate-500">
                        <%= t('admin.settings.notifications.newOrder.desc', 'إشعار عند استلام طلب جديد' ) %>
                    </p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="notif-new-order" checked data-setting-key="notifications_new_order" data-setting-type="boolean" class="sr-only peer">
                    <div
                        class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:bg-primary after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-[-20px]">
                    </div>
                </label>
            </div>

            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                <div>
                    <p class="font-medium text-slate-900">
                        <%= t('admin.settings.notifications.outOfStock.title', 'نفاذ المخزون' ) %>
                    </p>
                    <p class="text-xs text-slate-500">
                        <%= t('admin.settings.notifications.outOfStock.desc', 'تنبيه عند انخفاض مخزون المنتجات' ) %>
                    </p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="notif-out-of-stock" checked data-setting-key="notifications_out_of_stock" data-setting-type="boolean" class="sr-only peer">
                    <div
                        class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:bg-primary after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-[-20px]">
                    </div>
                </label>
            </div>

            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                <div>
                    <p class="font-medium text-slate-900">
                        <%= t('admin.settings.notifications.newCustomer.title', 'عميل جديد' ) %>
                    </p>
                    <p class="text-xs text-slate-500">
                        <%= t('admin.settings.notifications.newCustomer.desc', 'إشعار عند تسجيل عميل جديد' ) %>
                    </p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="notif-new-customer" data-setting-key="notifications_new_customer" data-setting-type="boolean" class="sr-only peer">
                    <div
                        class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:bg-primary after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-[-20px]">
                    </div>
                </label>
            </div>
        </div>
    </div>
</div>

<!-- Save Button -->
<div class="mt-8 flex justify-end">
    <button id="save-settings"
        class="h-11 px-8 bg-primary hover:bg-primary-dark text-white rounded-lg font-bold transition-colors flex items-center gap-2">
        <span class="material-symbols-outlined">save</span>
        <%= t('admin.settings.save', 'حفظ الإعدادات' ) %>
    </button>
</div>

<!-- Success Toast -->
<div id="success-toast"
    class="fixed bottom-4 left-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg hidden flex items-center gap-2">
    <span class="material-symbols-outlined">check_circle</span>
    <%= t('admin.settings.saved', 'تم حفظ الإعدادات بنجاح' ) %>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/admin/login';
            return;
        }

        const settingFields = Array.from(document.querySelectorAll('[data-setting-key]'));
        const toast = document.getElementById('success-toast');
        const trueValues = new Set(['1', 'true', 'on']);

        // Tab switching
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.settings-tab').forEach(t => {
                    t.classList.remove('active', 'bg-primary', 'text-white');
                    t.classList.add('bg-white', 'border', 'border-gray-200', 'text-slate-600');
                });
                this.classList.add('active', 'bg-primary', 'text-white');
                this.classList.remove('bg-white', 'border', 'border-gray-200', 'text-slate-600');

                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-${this.dataset.tab}`).classList.remove('hidden');
            });
        });

        async function loadSettings() {
            try {
                const response = await fetch('/api/admin/settings', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Unable to load settings');
                }

                const { settings = [] } = await response.json();
                const map = new Map(settings.map(item => [item.key, item]));
                settingFields.forEach(field => applySetting(field, map.get(field.dataset.settingKey)));
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function applySetting(field, setting) {
            if (!setting) return;
            const datasetType = field.dataset.settingType;
            const type = (datasetType || (field.type === 'checkbox' ? 'boolean' : field.type === 'number' ? 'number' : 'string')).toLowerCase();
            const value = setting.value;

            if (field.type === 'checkbox' || type === 'boolean') {
                field.checked = trueValues.has(String(value || '').toLowerCase());
                return;
            }

            field.value = value ?? '';
        }

        function buildPayload() {
            return settingFields.map(field => {
                const key = field.dataset.settingKey;
                if (!key) return null;
                const datasetType = field.dataset.settingType;
                const type = (datasetType || (field.type === 'checkbox' ? 'boolean' : field.type === 'number' ? 'number' : 'string')).toLowerCase();
                let rawValue;
                if (field.type === 'checkbox') {
                    rawValue = field.checked;
                } else {
                    rawValue = field.value;
                }

                let serialized;
                if (type === 'number') {
                    serialized = rawValue === '' || rawValue === null ? null : Number(rawValue).toString();
                } else if (type === 'boolean') {
                    serialized = rawValue ? 'true' : 'false';
                } else {
                    serialized = rawValue ?? '';
                }

                return { key, value: serialized, type };
            }).filter(Boolean);
        }

        async function saveSettings() {
            const payload = buildPayload();
            const response = await fetch('/api/admin/settings', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error('Failed to save settings');
            }
        }

        document.getElementById('save-settings').addEventListener('click', async function () {
            try {
                await saveSettings();
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 3000);
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        });

        loadSettings();
    });
</script>
