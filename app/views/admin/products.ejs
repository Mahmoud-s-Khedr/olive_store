<!-- Admin Products List -->

<!-- Page Header -->
<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
    <div>
        <h1 class="text-2xl font-bold text-slate-900">
            <%= t('admin.products.title', 'المنتجات' ) %>
        </h1>
        <p class="text-slate-500 mt-1">
            <%= t('admin.products.subtitle', 'إدارة منتجات المتجر' ) %>
        </p>
    </div>
    <a href="/admin/products/new"
        class="flex items-center gap-2 bg-primary hover:bg-primary-dark text-white px-4 py-2.5 rounded-lg font-bold text-sm transition-colors shadow-sm">
        <span class="material-symbols-outlined text-lg">add</span>
        <%= t('admin.products.add', 'إضافة منتج' ) %>
    </a>
</div>

<!-- Filters -->
<div class="bg-white rounded-xl border border-gray-100 p-4 mb-6">
    <div class="flex flex-wrap items-center gap-4">
        <!-- Search -->
        <div class="flex-1 min-w-[200px] relative">
            <span
                class="material-symbols-outlined absolute top-1/2 -translate-y-1/2 text-slate-400 rtl:right-3 ltr:left-3">search</span>
            <input type="text" id="search-input"
                placeholder="<%= t('admin.products.searchPlaceholder', 'بحث عن منتج...') %>"
                class="w-full h-10 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm rtl:pr-10 rtl:pl-4 ltr:pl-10 ltr:pr-4">
        </div>

        <!-- Category Filter -->
        <select id="category-filter"
            class="h-10 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm min-w-[150px]">
            <option value="">
                <%= t('admin.products.filterCategory', 'جميع الفئات' ) %>
            </option>
        </select>

        <!-- Stock Filter -->
        <select id="stock-filter"
            class="h-10 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
            <option value="">
                <%= t('admin.products.filterStock', 'جميع الحالات' ) %>
            </option>
            <option value="in_stock">
                <%= t('admin.products.status.inStock', 'متوفر' ) %>
            </option>
            <option value="low">
                <%= t('admin.products.status.lowStock', 'مخزون منخفض' ) %>
            </option>
            <option value="out">
                <%= t('admin.products.status.outOfStock', 'نفذ' ) %>
            </option>
        </select>
    </div>
</div>

<!-- Products Table -->
<div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-50 text-slate-500">
                <tr>
                    <th class="text-right px-6 py-4 font-medium rtl:text-right ltr:text-left">
                        <%= t('admin.products.table.product', 'المنتج' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium rtl:text-right ltr:text-left">
                        <%= t('admin.products.table.category', 'الفئة' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium rtl:text-right ltr:text-left">
                        <%= t('admin.products.table.price', 'السعر' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium rtl:text-right ltr:text-left">
                        <%= t('admin.products.table.stock', 'المخزون' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium rtl:text-right ltr:text-left">
                        <%= t('admin.products.table.status', 'الحالة' ) %>
                    </th>
                    <th class="text-center px-6 py-4 font-medium">
                        <%= t('admin.products.table.actions', 'الإجراءات' ) %>
                    </th>
                </tr>
            </thead>
            <tbody id="products-table" class="divide-y divide-gray-50">
                <tr>
                    <td colspan="6" class="px-6 py-12 text-center text-slate-400">
                        <%= t('admin.products.messages.loading', 'جاري التحميل...' ) %>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex items-center justify-between px-6 py-4 border-t border-gray-100">
        <p class="text-sm text-slate-500">
            <%= t('common.showing', 'عرض' ) %> <span id="showing-from">0</span>-<span id="showing-to">0</span>
                <%= t('common.from', 'من' ) %> <span id="total-count">0</span>
        </p>
        <div class="flex items-center gap-2">
            <button id="prev-page"
                class="h-9 px-3 rounded-lg border border-gray-200 text-slate-600 hover:bg-gray-50 disabled:opacity-50 text-sm">
                <%= t('common.previous', 'السابق' ) %>
            </button>
            <button id="next-page"
                class="h-9 px-3 rounded-lg border border-gray-200 text-slate-600 hover:bg-gray-50 disabled:opacity-50 text-sm">
                <%= t('common.next', 'التالي' ) %>
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6">
        <div class="text-center mb-6">
            <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
                <span class="material-symbols-outlined text-red-600 text-3xl">delete</span>
            </div>
            <h3 class="text-lg font-bold text-slate-900 mb-2">
                <%= t('admin.products.deleteModal.title', 'حذف المنتج' ) %>
            </h3>
            <p class="text-slate-500">
                <%= t('admin.products.deleteModal.message', 'هل أنت متأكد من حذف هذا المنتج؟ لا يمكن التراجع عن هذا الإجراء.'
                    ) %>
            </p>
        </div>
        <div class="flex gap-3">
            <button id="cancel-delete"
                class="flex-1 h-11 border border-gray-200 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                <%= t('admin.products.deleteModal.cancel', 'إلغاء' ) %>
            </button>
            <button id="confirm-delete"
                class="flex-1 h-11 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold transition-colors">
                <%= t('admin.products.deleteModal.confirm', 'حذف' ) %>
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const lang = typeof I18n !== 'undefined' ? I18n.getCurrentLanguage() : 'ar';
        const t = (key, fallback) => typeof I18n !== 'undefined' ? I18n.t(key, fallback) : fallback;

        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/admin/login';
            return;
        }

        let currentPage = 1;
        let currentSearch = '';
        let currentCategory = '';
        let currentStock = '';
        let deleteProductId = null;

        // Helper functions
        function formatPrice(price) {
            return Utils.formatPrice(price, lang);
        }

        function formatNum(num) {
            return lang === 'ar' ? Utils.toArabicNumerals(num) : num;
        }

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('category-filter');
                    data.categories?.forEach(cat => {
                        const name = lang === 'ar' ? cat.name_ar : (cat.name_en || cat.name_ar);
                        select.innerHTML += `<option value="${cat.id}">${name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load products
        async function loadProducts() {
            const tbody = document.getElementById('products-table');
            const loadingMsg = t('admin.products.messages.loading', 'جاري التحميل...');
            tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400">${loadingMsg}</td></tr>`;

            try {
                const params = new URLSearchParams();
                params.set('page', currentPage);
                params.set('limit', 10);
                if (currentSearch) params.set('search', currentSearch);
                if (currentCategory) params.set('category', currentCategory);
                if (currentStock) params.set('stock', currentStock);

                const response = await fetch(`/api/admin/products?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const products = data.products || data.items || [];
                    const total = Number.isFinite(data.total) ? data.total : products.length;
                    const page = Number.isFinite(data.page) ? data.page : currentPage;
                    const limit = Number.isFinite(data.limit) ? data.limit : 10;
                    const totalPages = Math.max(1, Math.ceil(total / limit));
                    const pagination = { total, page, limit, totalPages };

                    if (products.length === 0) {
                        const noProductsMsg = t('admin.products.messages.noProducts', 'لا توجد منتجات');
                        tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400">${noProductsMsg}</td></tr>`;
                        return;
                    }

                    const productName = (p) => lang === 'ar' ? p.name_ar : (p.name_en || p.name_ar);
                    const catName = (p) => {
                        if (p.category_name_ar || p.category_name_en || p.category_name) {
                            return lang === 'ar' ? (p.category_name_ar || p.category_name) : (p.category_name_en || p.category_name || '-');
                        }
                        return p.category_id ? `#${p.category_id}` : '-';
                    };
                    const activeText = t('admin.products.status.active', 'نشط');
                    const hiddenText = t('admin.products.status.hidden', 'مخفي');

                    let visibleProducts = products;
                    if (currentSearch) {
                        const q = currentSearch.toLowerCase();
                        visibleProducts = visibleProducts.filter((product) =>
                            [product.name_ar, product.name_en, product.slug, product.sku].some((field) =>
                                String(field || '').toLowerCase().includes(q)
                            )
                        );
                    }
                    if (currentCategory) {
                        visibleProducts = visibleProducts.filter((product) => String(product.category_id || '') === String(currentCategory));
                    }
                    if (currentStock) {
                        if (currentStock === 'in') {
                            visibleProducts = visibleProducts.filter((product) => Number(product.stock || 0) > 0);
                        } else if (currentStock === 'out') {
                            visibleProducts = visibleProducts.filter((product) => Number(product.stock || 0) <= 0);
                        }
                    }

                    tbody.innerHTML = visibleProducts.map(product => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden flex-shrink-0">
                                    ${product.primary_image ?
                            `<img src="${product.primary_image}" alt="" class="w-full h-full object-cover">` :
                            `<div class="w-full h-full flex items-center justify-center text-slate-400">
                                            <span class="material-symbols-outlined">inventory_2</span>
                                        </div>`
                        }
                                </div>
                                <div class="min-w-0">
                                    <p class="font-medium text-slate-900 truncate">${productName(product)}</p>
                                    <p class="text-xs text-slate-500 truncate rtl:text-right ltr:text-left">${product.sku || ''}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-slate-600 rtl:text-right ltr:text-left">${catName(product)}</td>
                        <td class="px-6 py-4 rtl:text-right ltr:text-left">
                            <span class="font-medium text-slate-900">${formatPrice(product.price)}</span>
                            ${product.old_price ? `<span class="text-xs text-slate-400 line-through mr-1">${formatPrice(product.old_price)}</span>` : ''}
                        </td>
                        <td class="px-6 py-4 rtl:text-right ltr:text-left">
                            <span class="${product.stock <= 0 ? 'text-red-600' : product.stock <= 5 ? 'text-amber-600' : 'text-slate-900'} font-medium">
                                ${formatNum(product.stock || 0)}
                            </span>
                        </td>
                        <td class="px-6 py-4 rtl:text-right ltr:text-left">
                            ${product.is_active !== false ?
                            `<span class="px-2 py-1 rounded-full bg-green-100 text-green-800 text-xs font-medium">${activeText}</span>` :
                            `<span class="px-2 py-1 rounded-full bg-gray-100 text-gray-600 text-xs font-medium">${hiddenText}</span>`
                        }
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center justify-center gap-2">
                                <a href="/admin/products/${product.id}/edit" class="p-2 rounded-lg hover:bg-gray-100 text-slate-600" title="${t('common.edit', 'تعديل')}">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </a>
                                <button class="delete-btn p-2 rounded-lg hover:bg-red-50 text-red-600" data-id="${product.id}" title="${t('common.delete', 'حذف')}">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                    // Update pagination
                    const displayTotal = (currentSearch || currentCategory || currentStock) ? visibleProducts.length : pagination.total;
                    const from = displayTotal === 0 ? 0 : (pagination.page - 1) * pagination.limit + 1;
                    const to = Math.min(from + visibleProducts.length - 1, displayTotal);

                    document.getElementById('showing-from').textContent = formatNum(from);
                    document.getElementById('showing-to').textContent = formatNum(to);
                    document.getElementById('total-count').textContent = formatNum(displayTotal);

                    const paginationWrapper = document.getElementById('pagination');
                    if (pagination.totalPages <= 1) {
                        paginationWrapper.classList.add('hidden');
                    } else {
                        paginationWrapper.classList.remove('hidden');
                    }

                    document.getElementById('prev-page').disabled = currentPage <= 1;
                    document.getElementById('next-page').disabled = currentPage >= pagination.totalPages;

                    // Delete buttons
                    document.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            deleteProductId = this.dataset.id;
                            document.getElementById('delete-modal').classList.remove('hidden');
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading products:', error);
                const errorMsg = t('admin.products.messages.errorLoading', 'حدث خطأ في التحميل');
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-red-500">${errorMsg}</td></tr>`;
            }
        }

        // Event listeners
        document.getElementById('search-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                currentSearch = this.value;
                currentPage = 1;
                loadProducts();
            }
        });

        document.getElementById('category-filter').addEventListener('change', function () {
            currentCategory = this.value;
            currentPage = 1;
            loadProducts();
        });

        document.getElementById('stock-filter').addEventListener('change', function () {
            currentStock = this.value;
            currentPage = 1;
            loadProducts();
        });

        document.getElementById('prev-page').addEventListener('click', function () {
            if (currentPage > 1) {
                currentPage--;
                loadProducts();
            }
        });

        document.getElementById('next-page').addEventListener('click', function () {
            currentPage++;
            loadProducts();
        });

        // Delete modal
        document.getElementById('cancel-delete').addEventListener('click', function () {
            document.getElementById('delete-modal').classList.add('hidden');
            deleteProductId = null;
        });

        document.getElementById('confirm-delete').addEventListener('click', async function () {
            if (!deleteProductId) return;

            try {
                const response = await fetch(`/api/admin/products/${deleteProductId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    document.getElementById('delete-modal').classList.add('hidden');
                    loadProducts();
                } else {
                    alert(t('admin.products.messages.deleteError', 'حدث خطأ أثناء الحذف'));
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                alert(t('admin.products.messages.deleteError', 'حدث خطأ أثناء الحذف'));
            }
        });

        // Initialize
        loadCategories();
        loadProducts();
    });
</script>
