<!-- Admin Files/Media Manager -->

<!-- Page Header -->
<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
    <div>
        <h1 class="text-2xl font-bold text-slate-900">
            <%= t('admin.files.title', 'إدارة الملفات' ) %>
        </h1>
        <p class="text-slate-500 mt-1">
            <%= t('admin.files.subtitle', 'رفع وإدارة الصور والملفات' ) %>
        </p>
    </div>
    <button id="upload-btn"
        class="flex items-center gap-2 bg-primary hover:bg-primary-dark text-white px-4 py-2.5 rounded-lg font-bold text-sm transition-colors shadow-sm">
        <span class="material-symbols-outlined text-lg">cloud_upload</span>
        <%= t('admin.files.uploadBtn', 'رفع ملف' ) %>
    </button>
</div>

<!-- Upload Area -->
<div id="upload-area" class="hidden mb-8 bg-white rounded-xl border-2 border-dashed border-primary/50 p-8 text-center">
    <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4">
        <span class="material-symbols-outlined text-primary text-3xl">cloud_upload</span>
    </div>
    <h3 class="font-bold text-slate-900 mb-2">
        <%= t('admin.files.dragHelp', 'اسحب الملفات هنا أو اضغط للاختيار' ) %>
    </h3>
    <p class="text-slate-500 text-sm mb-4">
        <%= t('admin.files.fileTypeNote', 'PNG, JPG, GIF, WEBP بحد أقصى 5 ميجا' ) %>
    </p>
    <input type="file" id="file-input" accept="image/*" multiple class="hidden">
    <button id="select-files"
        class="bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-lg font-medium text-sm transition-colors">
        <%= t('admin.files.selectFiles', 'اختيار الملفات' ) %>
    </button>
</div>

<!-- Upload Progress -->
<div id="upload-progress" class="hidden mb-6 bg-white rounded-xl border border-gray-100 p-4">
    <div class="flex items-center gap-4">
        <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
            <span class="material-symbols-outlined text-primary animate-spin">progress_activity</span>
        </div>
        <div class="flex-1">
            <p class="font-medium text-slate-900">
                <%= t('admin.files.uploading', 'جاري الرفع...' ) %>
            </p>
            <div class="w-full h-2 bg-gray-100 rounded-full mt-2 overflow-hidden">
                <div id="progress-bar" class="h-full bg-primary rounded-full transition-all" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>

<!-- Files Grid -->
<div class="bg-white rounded-xl border border-gray-100 p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="font-bold text-slate-900">
            <%= t('admin.files.uploadedFiles', 'الملفات المرفوعة' ) %>
        </h2>
        <div class="text-sm text-slate-500">
            <span id="files-count">0</span>
            <%= t('admin.files.fileUnit', 'ملف' ) %>
        </div>
    </div>

    <div id="files-grid" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4">
        <!-- Loading -->
        <div class="skeleton aspect-square rounded-lg"></div>
        <div class="skeleton aspect-square rounded-lg"></div>
        <div class="skeleton aspect-square rounded-lg"></div>
        <div class="skeleton aspect-square rounded-lg"></div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-12">
        <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
            <span class="material-symbols-outlined text-3xl text-slate-400">folder_open</span>
        </div>
        <p class="text-slate-500">
            <%= t('admin.files.noFiles', 'لا توجد ملفات مرفوعة' ) %>
        </p>
    </div>
</div>

<!-- File Preview Modal -->
<div id="preview-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
    <div class="max-w-4xl w-full">
        <div class="flex items-center justify-between mb-4">
            <input id="file-url" type="text" readonly
                class="flex-1 h-10 px-4 bg-white/10 border border-white/20 rounded-lg text-white text-sm font-mono"
                dir="ltr">
            <button id="copy-url"
                class="mr-2 h-10 px-4 bg-white text-slate-900 rounded-lg text-sm font-medium hover:bg-gray-100">
                <%= t('admin.files.copyLink', 'نسخ الرابط' ) %>
            </button>
            <button id="close-preview"
                class="mr-2 w-10 h-10 bg-white/10 hover:bg-white/20 rounded-lg text-white flex items-center justify-center">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <img id="preview-image" src="" alt="" class="max-h-[70vh] mx-auto rounded-lg">
        <div class="flex justify-center gap-4 mt-4">
            <button id="delete-file"
                class="h-10 px-6 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium flex items-center gap-2">
                <span class="material-symbols-outlined text-lg">delete</span>
                <%= t('admin.files.delete', 'حذف' ) %>
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const lang = typeof I18n !== 'undefined' ? I18n.getCurrentLanguage() : 'ar';
        const t = (key, fallback) => typeof I18n !== 'undefined' ? I18n.t(key, fallback) : fallback;

        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/admin/login';
            return;
        }

        let currentFileId = null;

        // Toggle upload area
        document.getElementById('upload-btn').addEventListener('click', function () {
            document.getElementById('upload-area').classList.toggle('hidden');
        });

        // Select files button
        document.getElementById('select-files').addEventListener('click', function () {
            document.getElementById('file-input').click();
        });

        // File input change
        document.getElementById('file-input').addEventListener('change', async function (e) {
            const files = e.target.files;
            if (files.length === 0) return;

            const uploadProgress = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');

            uploadProgress.classList.remove('hidden');
            document.getElementById('upload-area').classList.add('hidden');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    progressBar.style.width = `${((i + 0.5) / files.length) * 100}%`;

                    const response = await fetch('/api/admin/files/upload', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }

            setTimeout(() => {
                uploadProgress.classList.add('hidden');
                progressBar.style.width = '0%';
                loadFiles();
            }, 500);
        });

        // Load files
        async function loadFiles() {
            const grid = document.getElementById('files-grid');
            const emptyState = document.getElementById('empty-state');
            const countEl = document.getElementById('files-count');

            try {
                const response = await fetch('/api/admin/files', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const files = data.files || [];

                    countEl.textContent = files.length;

                    if (files.length === 0) {
                        grid.classList.add('hidden');
                        emptyState.classList.remove('hidden');
                        return;
                    }

                    grid.classList.remove('hidden');
                    emptyState.classList.add('hidden');

                    grid.innerHTML = files.map(file => `
                    <div class="file-item aspect-square rounded-lg overflow-hidden border border-gray-100 cursor-pointer hover:ring-2 hover:ring-primary transition-all group relative" data-id="${file.id}" data-url="${file.url}">
                        <img src="${file.url}" alt="" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <span class="material-symbols-outlined text-white text-2xl">zoom_in</span>
                        </div>
                    </div>
                `).join('');

                    // File click handlers
                    document.querySelectorAll('.file-item').forEach(item => {
                        item.addEventListener('click', function () {
                            currentFileId = this.dataset.id;
                            document.getElementById('preview-image').src = this.dataset.url;
                            document.getElementById('file-url').value = this.dataset.url;
                            document.getElementById('preview-modal').classList.remove('hidden');
                        });
                    });
                } else {
                    // Show sample files for demo
                    grid.innerHTML = `
                    <div class="aspect-square rounded-lg overflow-hidden border border-gray-100 bg-gray-50 flex items-center justify-center">
                        <span class="material-symbols-outlined text-slate-400 text-3xl">image</span>
                    </div>
                `.repeat(4);
                    countEl.textContent = '0';
                }
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }

        // Close preview
        document.getElementById('close-preview').addEventListener('click', function () {
            document.getElementById('preview-modal').classList.add('hidden');
        });

        // Copy URL
        document.getElementById('copy-url').addEventListener('click', function () {
            const urlInput = document.getElementById('file-url');
            urlInput.select();
            document.execCommand('copy');
            this.textContent = t('admin.files.copied', 'تم النسخ!');
            setTimeout(() => this.textContent = t('admin.files.copyLink', 'نسخ الرابط'), 2000);
        });

        // Delete file
        document.getElementById('delete-file').addEventListener('click', async function () {
            if (!currentFileId) return;

            if (!confirm(t('admin.files.confirmDelete', 'هل أنت متأكد من حذف هذا الملف؟'))) return;

            try {
                const response = await fetch(`/api/admin/files/${currentFileId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    document.getElementById('preview-modal').classList.add('hidden');
                    loadFiles();
                }
            } catch (error) {
                console.error('Error deleting file:', error);
            }
        });

        // Initialize
        loadFiles();
    });
</script>