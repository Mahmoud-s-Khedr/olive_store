<!-- Admin Orders List -->

<!-- Page Header -->
<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
    <div>
        <h1 class="text-2xl font-bold text-slate-900">
            <%= t('admin.orders.title', 'الطلبات' ) %>
        </h1>
        <p class="text-slate-500 mt-1">
            <%= t('admin.orders.subtitle', 'إدارة ومتابعة طلبات العملاء' ) %>
        </p>
    </div>
</div>

<!-- Status Tabs -->
<div class="flex flex-wrap gap-2 mb-6">
    <button class="status-tab active px-4 py-2 rounded-lg bg-primary text-white text-sm font-medium transition-colors"
        data-status="">
        <%= t('admin.orders.status.all', 'الكل' ) %>
    </button>
    <button
        class="status-tab px-4 py-2 rounded-lg bg-white border border-gray-200 text-slate-600 hover:border-primary text-sm font-medium transition-colors"
        data-status="pending">
        <%= t('admin.orders.status.pending', 'قيد الانتظار' ) %>
    </button>
    <button
        class="status-tab px-4 py-2 rounded-lg bg-white border border-gray-200 text-slate-600 hover:border-primary text-sm font-medium transition-colors"
        data-status="processing">
        <%= t('admin.orders.status.processing', 'جاري التجهيز' ) %>
    </button>
    <button
        class="status-tab px-4 py-2 rounded-lg bg-white border border-gray-200 text-slate-600 hover:border-primary text-sm font-medium transition-colors"
        data-status="shipped">
        <%= t('admin.orders.status.shipped', 'تم الشحن' ) %>
    </button>
    <button
        class="status-tab px-4 py-2 rounded-lg bg-white border border-gray-200 text-slate-600 hover:border-primary text-sm font-medium transition-colors"
        data-status="delivered">
        <%= t('admin.orders.status.delivered', 'تم التوصيل' ) %>
    </button>
    <button
        class="status-tab px-4 py-2 rounded-lg bg-white border border-gray-200 text-slate-600 hover:border-primary text-sm font-medium transition-colors"
        data-status="cancelled">
        <%= t('admin.orders.status.cancelled', 'ملغي' ) %>
    </button>
</div>

<!-- Search -->
<div class="bg-white rounded-xl border border-gray-100 p-4 mb-6">
    <div class="flex flex-wrap items-center gap-4">
        <div class="flex-1 min-w-[200px] relative">
            <span
                class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
            <input type="text" id="search-input"
                placeholder="<%= t('admin.orders.searchPlaceholder', 'بحث برقم الطلب أو اسم العميل...') %>"
                class="w-full h-10 pr-10 pl-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
        </div>
        <input type="date" id="date-from"
            class="h-10 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
        <span class="text-slate-400">
            <%= t('admin.orders.dateTo', 'إلى' ) %>
        </span>
        <input type="date" id="date-to"
            class="h-10 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
    </div>
</div>

<!-- Orders Table -->
<div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-50 text-slate-500">
                <tr>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.orders.table.orderId', 'رقم الطلب' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.orders.table.customer', 'العميل' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.orders.table.products', 'المنتجات' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.orders.table.total', 'الإجمالي' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.orders.table.payment', 'الدفع' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.orders.table.status', 'الحالة' ) %>
                    </th>
                    <th class="text-right px-6 py-4 font-medium">
                        <%= t('admin.orders.table.date', 'التاريخ' ) %>
                    </th>
                    <th class="text-center px-6 py-4 font-medium">
                        <%= t('admin.orders.table.actions', 'الإجراءات' ) %>
                    </th>
                </tr>
            </thead>
            <tbody id="orders-table" class="divide-y divide-gray-50">
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center text-slate-400">
                        <%= t('admin.orders.messages.loading', 'جاري التحميل...' ) %>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex items-center justify-between px-6 py-4 border-t border-gray-100">
        <p class="text-sm text-slate-500">
            <%= t('common.showing', 'عرض' ) %> <span id="showing-from">0</span>-<span id="showing-to">0</span>
                <%= t('common.from', 'من' ) %> <span id="total-count">0</span>
        </p>
        <div class="flex items-center gap-2">
            <button id="prev-page"
                class="h-9 px-3 rounded-lg border border-gray-200 text-slate-600 hover:bg-gray-50 disabled:opacity-50 text-sm">
                <%= t('common.previous', 'السابق' ) %>
            </button>
            <button id="next-page"
                class="h-9 px-3 rounded-lg border border-gray-200 text-slate-600 hover:bg-gray-50 disabled:opacity-50 text-sm">
                <%= t('common.next', 'التالي' ) %>
            </button>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div id="status-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6">
        <h3 class="text-lg font-bold text-slate-900 mb-4">
            <%= t('admin.orders.modal.title', 'تحديث حالة الطلب' ) %>
        </h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    <%= t('admin.orders.modal.newStatus', 'الحالة الجديدة' ) %>
                </label>
                <select id="new-status"
                    class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary">
                    <option value="pending">
                        <%= t('admin.orders.status.pending', 'قيد الانتظار' ) %>
                    </option>
                    <option value="processing">
                        <%= t('admin.orders.status.processing', 'جاري التجهيز' ) %>
                    </option>
                    <option value="shipped">
                        <%= t('admin.orders.status.shipped', 'تم الشحن' ) %>
                    </option>
                    <option value="delivered">
                        <%= t('admin.orders.status.delivered', 'تم التوصيل' ) %>
                    </option>
                    <option value="cancelled">
                        <%= t('admin.orders.status.cancelled', 'ملغي' ) %>
                    </option>
                </select>
            </div>
            <div class="flex gap-3 pt-2">
                <button id="cancel-status"
                    class="flex-1 h-11 border border-gray-200 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                    <%= t('admin.orders.modal.cancel', 'إلغاء' ) %>
                </button>
                <button id="confirm-status"
                    class="flex-1 h-11 bg-primary hover:bg-primary-dark text-white rounded-lg font-bold transition-colors">
                    <%= t('admin.orders.modal.update', 'تحديث' ) %>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const lang = typeof I18n !== 'undefined' ? I18n.getCurrentLanguage() : 'ar';
        const t = (key, fallback) => typeof I18n !== 'undefined' ? I18n.t(key, fallback) : fallback;

        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/admin/login';
            return;
        }

        let currentPage = 1;
        let currentStatus = '';
        let currentSearch = '';
        let updateOrderId = null;

        // Convert to Arabic numerals
        function toArabicNum(num) {
            if (lang !== 'ar') return num;
            const arabicNums = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return String(num).split('').map(d => arabicNums[parseInt(d)] || d).join('');
        }

        function formatPrice(price) {
            if (lang !== 'ar') {
                return parseFloat(price || 0).toFixed(2) + ' EGP';
            }
            return toArabicNum(parseFloat(price || 0).toFixed(0)) + ' ج.م';
        }

        function formatDate(dateStr) {
            const locale = lang === 'ar' ? 'ar-EG' : 'en-US';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateStr).toLocaleDateString(locale, options);
        }

        function getStatusBadge(status) {
            const statuses = {
                'pending': { label: t('admin.orders.status.pending', 'قيد الانتظار'), class: 'bg-amber-100 text-amber-800' },
                'processing': { label: t('admin.orders.status.processing', 'جاري التجهيز'), class: 'bg-blue-100 text-blue-800' },
                'shipped': { label: t('admin.orders.status.shipped', 'تم الشحن'), class: 'bg-purple-100 text-purple-800' },
                'delivered': { label: t('admin.orders.status.delivered', 'تم التوصيل'), class: 'bg-green-100 text-green-800' },
                'cancelled': { label: t('admin.orders.status.cancelled', 'ملغي'), class: 'bg-red-100 text-red-800' }
            };
            const s = statuses[status] || statuses['pending'];
            return `<span class="px-2.5 py-1 rounded-full text-xs font-medium ${s.class}">${s.label}</span>`;
        }

        function getPaymentBadge(method) {
            return method === 'cod' ?
                `<span class="text-slate-600">${t('admin.orders.payment.cod', 'عند الاستلام')}</span>` :
                `<span class="text-primary">${t('admin.orders.payment.card', 'بطاقة')}</span>`;
        }

        // Load orders
        async function loadOrders() {
            const tbody = document.getElementById('orders-table');
            tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-12 text-center text-slate-400">${t('admin.orders.messages.loading', 'جاري التحميل...')}</td></tr>`;

            try {
                const params = new URLSearchParams();
                params.set('page', currentPage);
                params.set('limit', 10);
                if (currentStatus) params.set('status', currentStatus);
                if (currentSearch) params.set('search', currentSearch);

                const response = await fetch(`/api/admin/orders?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const orders = data.orders || [];
                    const pagination = data.pagination || {};

                    if (orders.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-12 text-center text-slate-400">${t('admin.orders.messages.noOrders', 'لا توجد طلبات')}</td></tr>`;
                        return;
                    }

                    tbody.innerHTML = orders.map(order => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <a href="/admin/orders/${order.id}" class="text-primary font-medium hover:underline">#${order.id}</a>
                        </td>
                        <td class="px-6 py-4">
                            <div>
                                <p class="font-medium text-slate-900">${order.customer_name || order.shipping_address?.name || t('admin.orders.messages.unknown', 'غير معروف')}</p>
                                <p class="text-xs text-slate-500">${order.customer_phone || order.shipping_address?.phone || ''}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-slate-600">${toArabicNum(order.items_count || order.items?.length || 0)} ${t('admin.orders.itemCount', 'منتج')}</td>
                        <td class="px-6 py-4 font-bold text-slate-900">${formatPrice(order.total)}</td>
                        <td class="px-6 py-4">${getPaymentBadge(order.payment_method)}</td>
                        <td class="px-6 py-4">${getStatusBadge(order.status)}</td>
                        <td class="px-6 py-4 text-slate-500">${formatDate(order.created_at)}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center justify-center gap-2">
                                <a href="/admin/orders/${order.id}" class="p-2 rounded-lg hover:bg-gray-100 text-slate-600" title="${t('common.view', 'عرض')}">
                                    <span class="material-symbols-outlined text-lg">visibility</span>
                                </a>
                                <button class="status-update-btn p-2 rounded-lg hover:bg-primary/10 text-primary" data-id="${order.id}" data-status="${order.status}" title="${t('admin.orders.modal.title', 'تحديث الحالة')}">
                                    <span class="material-symbols-outlined text-lg">sync</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                    // Update pagination
                    const total = pagination.total || orders.length;
                    const from = ((pagination.page || 1) - 1) * 10 + 1;
                    const to = Math.min(from + orders.length - 1, total);

                    document.getElementById('showing-from').textContent = toArabicNum(from);
                    document.getElementById('showing-to').textContent = toArabicNum(to);
                    document.getElementById('total-count').textContent = toArabicNum(total);

                    document.getElementById('prev-page').disabled = currentPage <= 1;
                    document.getElementById('next-page').disabled = currentPage >= (pagination.totalPages || 1);

                    // Status update buttons
                    document.querySelectorAll('.status-update-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            updateOrderId = this.dataset.id;
                            document.getElementById('new-status').value = this.dataset.status;
                            document.getElementById('status-modal').classList.remove('hidden');
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-12 text-center text-red-500">${t('admin.orders.messages.error', 'حدث خطأ في التحميل')}</td></tr>`;
            }
        }

        // Status tabs
        document.querySelectorAll('.status-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.status-tab').forEach(t => {
                    t.classList.remove('active', 'bg-primary', 'text-white');
                    t.classList.add('bg-white', 'border', 'border-gray-200', 'text-slate-600');
                });
                this.classList.add('active', 'bg-primary', 'text-white');
                this.classList.remove('bg-white', 'border', 'border-gray-200', 'text-slate-600');

                currentStatus = this.dataset.status;
                currentPage = 1;
                loadOrders();
            });
        });

        // Search
        document.getElementById('search-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                currentSearch = this.value;
                currentPage = 1;
                loadOrders();
            }
        });

        // Pagination
        document.getElementById('prev-page').addEventListener('click', function () {
            if (currentPage > 1) { currentPage--; loadOrders(); }
        });

        document.getElementById('next-page').addEventListener('click', function () {
            currentPage++;
            loadOrders();
        });

        // Status modal
        document.getElementById('cancel-status').addEventListener('click', function () {
            document.getElementById('status-modal').classList.add('hidden');
            updateOrderId = null;
        });

        document.getElementById('confirm-status').addEventListener('click', async function () {
            if (!updateOrderId) return;

            try {
                const response = await fetch(`/api/admin/orders/${updateOrderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: document.getElementById('new-status').value })
                });

                if (response.ok) {
                    document.getElementById('status-modal').classList.add('hidden');
                    loadOrders();
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        });

        // Initialize
        loadOrders();
    });
</script>
