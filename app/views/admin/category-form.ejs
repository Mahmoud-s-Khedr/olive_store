<!-- Admin Category Form -->

<!-- Page Header -->
<div class="mb-8">
    <nav class="flex items-center gap-2 text-sm text-slate-500 mb-4">
        <a href="/admin" class="hover:text-primary">
            <%= t('admin.menu.dashboard', 'لوحة التحكم' ) %>
        </a>
        <span>/</span>
        <a href="/admin/categories" class="hover:text-primary">
            <%= t('admin.menu.categories', 'الفئات' ) %>
        </a>
        <span>/</span>
        <span id="breadcrumb-current" class="text-slate-700">
            <%= t('admin.categories.form.titleNew', 'فئة جديدة' ) %>
        </span>
    </nav>
    <h1 id="page-title" class="text-2xl font-bold text-slate-900">
        <%= t('admin.categories.form.headerNew', 'إضافة فئة جديدة' ) %>
    </h1>
</div>

<form id="category-form" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <input type="hidden" id="category-id">

    <!-- Main Area -->
    <div class="lg:col-span-2 space-y-6">

        <div class="bg-white rounded-xl border border-gray-100 p-6 space-y-5">
            <h2 class="font-bold text-slate-900 mb-4">
                <%= t('admin.categories.form.basic', 'معلومات الفئة' ) %>
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.categories.form.nameAr', 'الاسم بالعربية' ) %> <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="name-ar" required
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm rtl:text-right ltr:text-left">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.categories.form.nameEn', 'الاسم بالإنجليزية' ) %>
                    </label>
                    <input type="text" id="name-en" dir="ltr"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    <%= t('admin.categories.form.slug', 'Slug' ) %>
                </label>
                <input type="text" id="slug" dir="ltr"
                    placeholder="<%= t('admin.productForm.placeholders.slugAuto', 'auto-generated') %>"
                    class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm bg-gray-50">
            </div>
        </div>

        <div class="bg-white rounded-xl border border-gray-100 p-6 space-y-5">
            <h2 class="font-bold text-slate-900 mb-4">
                <%= t('admin.categories.form.details', 'تفاصيل إضافية' ) %>
            </h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.categories.form.descriptionAr', 'الوصف بالعربية' ) %>
                    </label>
                    <textarea id="description-ar" rows="3"
                        class="w-full px-4 py-3 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm rtl:text-right ltr:text-left"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.categories.form.descriptionEn', 'الوصف بالإنجليزية' ) %>
                    </label>
                    <textarea id="description-en" rows="3"
                        class="w-full px-4 py-3 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm rtl:text-right ltr:text-left"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.categories.form.image', 'رابط الصورة' ) %>
                    </label>
                    <input type="url" id="image-url" dir="ltr"
                        placeholder="<%= t('admin.productForm.placeholders.url', 'https://...') %>"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.categories.form.parent', 'فئة رئيسية' ) %>
                    </label>
                    <select id="parent-id"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                        <option value=""><%= t('admin.categories.form.parentNone', 'بدون فئة رئيسية' ) %></option>
                    </select>
                </div>
            </div>
        </div>

    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <div class="bg-white rounded-xl border border-gray-100 p-6 space-y-5">
            <h2 class="font-bold text-slate-900 mb-4">
                <%= t('admin.categories.form.settings', 'الإعدادات' ) %>
            </h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <%= t('admin.categories.form.sortOrder', 'ترتيب العرض' ) %>
                    </label>
                    <input type="number" id="sort-order" min="0" value="0"
                        class="w-full h-11 px-4 rounded-lg border-gray-200 focus:border-primary focus:ring-primary text-sm">
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="is-active" checked
                        class="rounded border-gray-300 text-primary focus:ring-primary">
                    <label for="is-active" class="text-sm text-slate-700">
                        <%= t('admin.categories.form.active', 'فئة نشطة' ) %>
                    </label>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl border border-gray-100 p-6 space-y-4">
            <div id="form-error"
                class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>

            <div class="flex gap-3">
                <a href="/admin/categories"
                    class="flex-1 h-11 border border-gray-200 rounded-lg font-medium hover:bg-gray-50 transition-colors flex items-center justify-center">
                    <%= t('common.cancel', 'إلغاء' ) %>
                </a>
                <button type="submit" id="submit-btn"
                    class="flex-1 h-11 bg-primary hover:bg-primary-dark text-white rounded-lg font-bold transition-colors flex items-center justify-center gap-2">
                    <span id="submit-text">
                        <%= t('common.save', 'حفظ' ) %>
                    </span>
                    <span id="submit-spinner" class="spinner hidden"></span>
                </button>
            </div>
        </div>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const lang = typeof I18n !== 'undefined' ? I18n.getCurrentLanguage() : 'ar';
        const t = (key, fallback) => typeof I18n !== 'undefined' ? I18n.t(key, fallback) : fallback;

        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/admin/login';
            return;
        }

        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');
        const formError = document.getElementById('form-error');
        const nameArInput = document.getElementById('name-ar');
        const nameEnInput = document.getElementById('name-en');
        const slugInput = document.getElementById('slug');
        const descArInput = document.getElementById('description-ar');
        const descEnInput = document.getElementById('description-en');
        const imageInput = document.getElementById('image-url');
        const parentSelect = document.getElementById('parent-id');
        const sortInput = document.getElementById('sort-order');
        const activeInput = document.getElementById('is-active');

        const match = window.location.pathname.match(/\/admin\/categories\/(\d+)\/edit/);
        const categoryId = match ? match[1] : null;
        const isEdit = Boolean(categoryId);

        if (isEdit) {
            document.getElementById('page-title').textContent = t('admin.categories.form.headerEdit', 'تعديل الفئة');
            document.getElementById('breadcrumb-current').textContent = t('admin.categories.form.titleEdit', 'تعديل الفئة');
        }

        async function loadParentCategories(excludeId) {
            try {
                const response = await fetch('/api/admin/categories', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Unable to load parents');

                const data = await response.json();
                const categories = (data.categories || []).filter(c => String(c.id) !== String(excludeId));
                parentSelect.innerHTML = `<option value="">${t('admin.categories.form.parentNone', 'بدون فئة رئيسية')}</option>`;
                categories.forEach(cat => {
                    const label = lang === 'ar' ? cat.name_ar : (cat.name_en || cat.name_ar);
                    parentSelect.innerHTML += `<option value="${cat.id}">${label}</option>`;
                });
            } catch (error) {
                console.error('Error loading parent categories:', error);
            }
        }

        async function loadCategory() {
            if (!isEdit) return;
            try {
                const response = await fetch(`/api/admin/categories/${categoryId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Category not found');

                const data = await response.json();
                const category = data.category || {};
                nameArInput.value = category.name_ar || '';
                nameEnInput.value = category.name_en || '';
                slugInput.value = category.slug || '';
                descArInput.value = category.description_ar || '';
                descEnInput.value = category.description_en || '';
                imageInput.value = category.image_url || '';
                sortInput.value = category.sort_order ?? 0;
                activeInput.checked = category.is_active !== false;
                parentSelect.value = category.parent_id || '';
            } catch (error) {
                console.error('Error loading category:', error);
            }
        }

        async function saveCategory(payload) {
            const url = isEdit ? `/api/admin/categories/${categoryId}` : '/api/admin/categories';
            const method = isEdit ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                throw new Error(data.message || t('admin.categories.messages.error', 'حدث خطأ أثناء الحفظ'));
            }
        }

        formError.classList.add('hidden');

        document.getElementById('category-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            formError.classList.add('hidden');
            submitBtn.disabled = true;
            const originalText = submitText.textContent;
            submitText.textContent = isEdit ? t('admin.categories.form.savingEdit', 'جاري التحديث...') : t('admin.categories.form.saving', 'جاري الحفظ...');
            submitSpinner.classList.remove('hidden');

            const payload = {
                name_ar: nameArInput.value.trim(),
                name_en: nameEnInput.value.trim() || undefined,
                slug: slugInput.value.trim() || undefined,
                description_ar: descArInput.value.trim() || undefined,
                description_en: descEnInput.value.trim() || undefined,
                image_url: imageInput.value.trim() || undefined,
                parent_id: parentSelect.value ? Number(parentSelect.value) : null,
                sort_order: Number(sortInput.value) || 0,
                is_active: activeInput.checked,
            };

            try {
                await saveCategory(payload);
                window.location.href = '/admin/categories';
            } catch (error) {
                console.error('Save error:', error);
                formError.textContent = error.message || t('admin.categories.messages.error', 'حدث خطأ أثناء الحفظ');
                formError.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitText.textContent = originalText;
                submitSpinner.classList.add('hidden');
            }
        });

        await loadParentCategories(categoryId);
        if (isEdit) {
            await loadCategory();
        }
    });
</script>
