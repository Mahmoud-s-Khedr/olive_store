<!-- Product Detail Page -->
<div class="max-w-[1280px] mx-auto px-4 lg:px-8 py-6 lg:py-10">

    <!-- Breadcrumbs -->
    <nav class="flex flex-wrap items-center gap-2 mb-8 text-sm">
        <a href="/" class="text-olive-light hover:text-primary transition-colors">الرئيسية</a>
        <span class="text-olive-light material-symbols-outlined text-sm rotate-180">chevron_right</span>
        <a href="/products" class="text-olive-light hover:text-primary transition-colors">المتجر</a>
        <span class="text-olive-light material-symbols-outlined text-sm rotate-180">chevron_right</span>
        <span id="breadcrumb-product" class="text-olive-dark font-medium">تفاصيل المنتج</span>
    </nav>

    <!-- Loading State -->
    <div id="loading-state" class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <div class="skeleton aspect-[4/3] rounded-2xl"></div>
        <div class="space-y-4">
            <div class="skeleton h-10 w-3/4 rounded"></div>
            <div class="skeleton h-6 w-1/2 rounded"></div>
            <div class="skeleton h-8 w-1/4 rounded"></div>
            <div class="skeleton h-24 w-full rounded"></div>
        </div>
    </div>

    <!-- Product Content -->
    <div id="product-content" class="hidden">

        <!-- Product Detail Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 xl:gap-20">

            <!-- Image Gallery -->
            <div class="flex flex-col gap-4">
                <!-- Main Image -->
                <div
                    class="aspect-[4/3] w-full rounded-2xl overflow-hidden bg-white shadow-sm border border-gray-100 relative group cursor-zoom-in">
                    <img id="main-image" src="" alt=""
                        class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                    <div id="product-badge" class="absolute top-4 left-4 z-10 hidden">
                        <span class="bg-primary text-white text-xs font-bold px-3 py-1 rounded-full">جديد</span>
                    </div>
                </div>

                <!-- Thumbnails -->
                <div id="thumbnails" class="grid grid-cols-4 gap-3">
                    <!-- Thumbnails loaded dynamically -->
                </div>
            </div>

            <!-- Product Info -->
            <div class="flex flex-col pt-2">
                <div class="mb-4">
                    <h1 id="product-name-ar" class="text-olive-dark text-3xl lg:text-4xl font-bold leading-tight mb-2">
                    </h1>
                    <h2 id="product-name-en" class="text-olive-light text-lg font-medium"></h2>
                </div>

                <!-- Rating -->
                <div class="flex items-center gap-2 mb-6">
                    <div class="flex text-amber-400 text-sm">
                        <span class="material-symbols-outlined fill text-lg">star</span>
                        <span class="material-symbols-outlined fill text-lg">star</span>
                        <span class="material-symbols-outlined fill text-lg">star</span>
                        <span class="material-symbols-outlined fill text-lg">star</span>
                        <span class="material-symbols-outlined text-lg">star_half</span>
                    </div>
                    <span class="text-sm text-olive-light">(٤٥ تقييم)</span>
                </div>

                <!-- Price -->
                <div class="flex items-end gap-3 mb-6">
                    <span id="product-price" class="text-primary text-3xl font-bold"></span>
                    <span id="product-old-price"
                        class="text-olive-light text-lg line-through decoration-red-500/50 hidden"></span>
                </div>

                <!-- Description -->
                <p id="product-description" class="text-olive-dark/80 text-base leading-relaxed mb-6"></p>

                <!-- Stock Status -->
                <div id="stock-status" class="flex items-center gap-2 mb-8">
                    <span class="relative flex h-3 w-3">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                    <span class="text-green-700 font-medium text-sm">متوفر في المخزون</span>
                </div>

                <!-- Controls -->
                <div class="flex flex-col sm:flex-row gap-4 mb-8 pb-8 border-b border-gray-200">
                    <!-- Quantity -->
                    <div class="flex items-center border border-primary/50 rounded-lg h-12 w-fit bg-white">
                        <button id="qty-increase"
                            class="px-3 text-primary hover:bg-primary/10 h-full rounded-r-lg transition-colors">
                            <span class="material-symbols-outlined text-sm">add</span>
                        </button>
                        <input type="text" id="quantity" value="١" readonly
                            class="w-12 text-center border-none p-0 h-full text-olive-dark focus:ring-0 bg-transparent">
                        <button id="qty-decrease"
                            class="px-3 text-primary hover:bg-primary/10 h-full rounded-l-lg transition-colors">
                            <span class="material-symbols-outlined text-sm">remove</span>
                        </button>
                    </div>

                    <!-- Add to Cart -->
                    <button id="add-to-cart-btn"
                        class="flex-1 bg-accent hover:bg-accent-dark text-white font-bold h-12 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">shopping_bag</span>
                        <span>أضف للسلة</span>
                    </button>

                    <!-- Wishlist -->
                    <button
                        class="h-12 w-12 flex items-center justify-center border border-primary/30 rounded-lg text-primary hover:bg-primary/5 transition-colors group">
                        <span
                            class="material-symbols-outlined group-hover:scale-110 transition-transform">favorite_border</span>
                    </button>
                </div>

                <!-- Trust Badges -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-2xl">verified_user</span>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold">منتج أصلي ١٠٠٪</span>
                            <span class="text-xs text-olive-light">ضمان الجودة</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-2xl">local_shipping</span>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold">شحن سريع</span>
                            <span class="text-xs text-olive-light">لجميع المحافظات</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="mt-20">
            <div class="border-b border-gray-200">
                <nav class="flex gap-8">
                    <button
                        class="tab-btn active border-b-2 border-primary py-4 px-1 text-center text-base font-bold text-primary"
                        data-tab="description">
                        الوصف
                    </button>
                    <button
                        class="tab-btn border-b-2 border-transparent py-4 px-1 text-center text-base font-medium text-olive-light hover:text-olive-dark hover:border-gray-300"
                        data-tab="specs">
                        المواصفات
                    </button>
                    <button
                        class="tab-btn border-b-2 border-transparent py-4 px-1 text-center text-base font-medium text-olive-light hover:text-olive-dark hover:border-gray-300"
                        data-tab="reviews">
                        التقييمات
                    </button>
                </nav>
            </div>

            <div class="py-8">
                <!-- Description Tab -->
                <div id="tab-description" class="tab-content">
                    <div id="full-description" class="prose prose-stone max-w-none text-olive-dark/80 leading-7"></div>
                </div>

                <!-- Specs Tab -->
                <div id="tab-specs" class="tab-content hidden">
                    <table class="w-full max-w-xl">
                        <tbody id="specs-table" class="divide-y divide-gray-100">
                            <!-- Specs loaded dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Reviews Tab -->
                <div id="tab-reviews" class="tab-content hidden">
                    <p class="text-olive-light">لا توجد تقييمات حتى الآن.</p>
                </div>
            </div>
        </div>

        <!-- Related Products -->
        <div class="mt-16 mb-8">
            <h2 class="text-2xl font-bold mb-8 text-olive-dark">منتجات ذات صلة</h2>
            <div id="related-products" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <!-- Related products loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Not Found State -->
    <div id="not-found" class="hidden text-center py-20">
        <span class="material-symbols-outlined text-6xl text-olive-light mb-4">search_off</span>
        <h2 class="text-2xl font-bold text-olive-dark mb-2">المنتج غير موجود</h2>
        <p class="text-olive-light mb-6">المنتج الذي تبحث عنه غير متوفر</p>
        <a href="/products"
            class="inline-flex items-center gap-2 bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg font-bold transition-colors">
            <span class="material-symbols-outlined">arrow_forward</span>
            تصفح المنتجات
        </a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        // Get product slug from URL
        const pathParts = window.location.pathname.split('/');
        const slug = pathParts[pathParts.length - 1];

        const lang = typeof I18n !== 'undefined' ? I18n.getCurrentLanguage() : '<%= lang %>';
        const t = (key, fallback) => typeof I18n !== 'undefined' ? I18n.t(key, fallback) : fallback;

        let quantity = 1;
        let productData = null;

        // Convert to Arabic numerals
        function toArabicNum(num) {
            const arabicNums = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return String(num).split('').map(d => arabicNums[parseInt(d)] || d).join('');
        }

        function formatPrice(value) {
            if (typeof Utils !== 'undefined' && Utils.formatPrice) {
                return Utils.formatPrice(value, lang);
            }
            return `${value} ${lang === 'ar' ? 'ج.م' : 'EGP'}`;
        }

        function getImageUrl(image) {
            if (!image) return '';
            if (typeof image === 'string') return image;
            if (image.publicUrl) return image.publicUrl;
            if (image.url) return image.url;
            if (image.r2_key && Config.R2_PUBLIC_URL) {
                return `${Config.R2_PUBLIC_URL}/${image.r2_key}`;
            }
            return '';
        }

        // Load product
        async function loadProduct() {
            try {
                const response = await fetch(`/api/products/${slug}`);

                if (!response.ok) {
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('not-found').classList.remove('hidden');
                    return;
                }

                const data = await response.json();
                productData = data.product || data;

                // Hide loading, show content
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('product-content').classList.remove('hidden');

                // Populate data
                const nameAr = productData.name_ar || productData.name_en || '';
                const nameEn = productData.name_en || '';
                document.getElementById('breadcrumb-product').textContent = nameAr;
                document.getElementById('product-name-ar').textContent = nameAr;
                document.getElementById('product-name-en').textContent = nameEn;
                document.getElementById('product-price').textContent = formatPrice(productData.price);

                if (productData.old_price) {
                    const oldPriceEl = document.getElementById('product-old-price');
                    oldPriceEl.textContent = formatPrice(productData.old_price);
                    oldPriceEl.classList.remove('hidden');
                }

                document.getElementById('product-description').textContent = productData.short_description_ar || productData.description_ar || '';
                document.getElementById('full-description').innerHTML = productData.description_ar || productData.short_description_ar || t('products.noDescription', 'لا يوجد وصف متاح');

                // Main image
                const mainImage = document.getElementById('main-image');
                const images = Array.isArray(productData.images) ? productData.images : [];
                const primaryImage = getImageUrl(productData.primary_image) || getImageUrl(images.find((img) => img.is_primary)) || getImageUrl(images[0]);
                if (primaryImage) {
                    mainImage.src = primaryImage;
                    mainImage.alt = nameAr;
                } else {
                    mainImage.src = Config.PLACEHOLDER_PRODUCT;
                }

                // Thumbnails
                if (images.length > 0) {
                    const thumbsContainer = document.getElementById('thumbnails');
                    thumbsContainer.innerHTML = images.slice(0, 4).map((img, index) => {
                        const imgUrl = getImageUrl(img);
                        if (!imgUrl) return '';
                        return `
                    <button class="thumb-btn aspect-square rounded-lg overflow-hidden border-2 ${index === 0 ? 'border-primary' : 'border-transparent hover:border-olive-light'} p-0.5 bg-white transition-all" data-url="${imgUrl}">
                        <img src="${imgUrl}" alt="" class="w-full h-full object-cover rounded-md">
                    </button>
                `;
                    }).join('');

                    // Thumbnail clicks
                    document.querySelectorAll('.thumb-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            mainImage.src = this.dataset.url;
                            document.querySelectorAll('.thumb-btn').forEach(b => b.classList.remove('border-primary'));
                            this.classList.add('border-primary');
                        });
                    });
                }

                // Stock status
                const stockStatus = document.getElementById('stock-status');
                if (productData.stock <= 0) {
                    stockStatus.innerHTML = `
                    <span class="relative flex h-3 w-3">
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                    </span>
                    <span class="text-red-700 font-medium text-sm">${t('products.stock.out', 'غير متوفر حالياً')}</span>
                `;
                    document.getElementById('add-to-cart-btn').disabled = true;
                    document.getElementById('add-to-cart-btn').classList.add('opacity-50', 'cursor-not-allowed');
                } else if (productData.stock <= 5) {
                    stockStatus.innerHTML = `
                    <span class="relative flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-amber-500"></span>
                    </span>
                    <span class="text-amber-700 font-medium text-sm">${t('products.stock.low', 'كمية محدودة')} - ${toArabicNum(productData.stock)} ${t('products.stock.remaining', 'قطع متبقية')}</span>
                `;
                }

                // Specs
                const specsTable = document.getElementById('specs-table');
                specsTable.innerHTML = `
                <tr class="hover:bg-gray-50">
                    <td class="py-3 text-olive-light font-medium">الوزن</td>
                    <td class="py-3 text-olive-dark">${productData.weight || t('products.specs.na', 'غير محدد')}</td>
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="py-3 text-olive-light font-medium">الأبعاد</td>
                    <td class="py-3 text-olive-dark">${productData.dimensions || t('products.specs.na', 'غير محدد')}</td>
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="py-3 text-olive-light font-medium">SKU</td>
                    <td class="py-3 text-olive-dark" dir="ltr">${productData.sku || productData.id}</td>
                </tr>
            `;

                // Load related products
                loadRelatedProducts();

            } catch (error) {
                console.error('Error loading product:', error);
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('not-found').classList.remove('hidden');
            }
        }

        // Load related products
        async function loadRelatedProducts() {
            try {
                const params = new URLSearchParams();
                params.set('limit', 4);
                if (productData.category_slug) params.set('category', productData.category_slug);

                const response = await fetch(`/api/products?${params.toString()}`);
                const data = await response.json();

                if (response.ok && data.products) {
                    const related = data.products.filter(p => p.id !== productData.id).slice(0, 4);
                    const container = document.getElementById('related-products');

                    if (related.length > 0) {
                        container.innerHTML = related.map(product => `
                        <a href="/products/${product.slug}" class="group flex flex-col gap-3">
                            <div class="w-full aspect-[4/5] bg-white rounded-xl overflow-hidden relative shadow-sm hover:shadow-md transition-all">
                                ${product.primary_image ?
                                `<img src="${product.primary_image}" alt="${product.name_ar}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">` :
                                `<div class="w-full h-full flex items-center justify-center text-olive-light bg-gray-50">
                                        <span class="material-symbols-outlined text-4xl">inventory_2</span>
                                    </div>`
                            }
                            </div>
                            <div>
                                <h3 class="font-bold text-olive-dark text-sm hover:text-primary cursor-pointer truncate">${product.name_ar || product.name_en || ''}</h3>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-primary font-bold text-sm">${formatPrice(product.price)}</span>
                                </div>
                            </div>
                        </a>
                    `).join('');
                    } else {
                        container.innerHTML = '<p class="col-span-full text-center text-olive-light">لا توجد منتجات مشابهة</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading related products:', error);
            }
        }

        // Quantity controls
        document.getElementById('qty-increase').addEventListener('click', function () {
            if (productData && quantity < productData.stock) {
                quantity++;
                document.getElementById('quantity').value = toArabicNum(quantity);
            }
        });

        document.getElementById('qty-decrease').addEventListener('click', function () {
            if (quantity > 1) {
                quantity--;
                document.getElementById('quantity').value = toArabicNum(quantity);
            }
        });

        // Add to cart
        document.getElementById('add-to-cart-btn').addEventListener('click', function () {
            if (!productData || productData.stock <= 0) return;

            const name = lang === 'ar' ? productData.name_ar : (productData.name_en || productData.name_ar);
            const imageUrl = getImageUrl(productData.primary_image) || (Array.isArray(productData.images) ? getImageUrl(productData.images[0]) : '');
            if (typeof Cart !== 'undefined') {
                Cart.addItem({
                    id: productData.id,
                    name,
                    slug: productData.slug,
                    price: productData.price,
                    image: imageUrl || Config.PLACEHOLDER_PRODUCT
                }, quantity);
            }

            const msg = t('products.addedToCart', 'تمت الإضافة للسلة');
            if (typeof Utils !== 'undefined') {
                Utils.showToast(msg, 'success');
            }
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                // Update button states
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active', 'border-primary', 'text-primary', 'font-bold');
                    b.classList.add('border-transparent', 'text-olive-light', 'font-medium');
                });
                this.classList.add('active', 'border-primary', 'text-primary', 'font-bold');
                this.classList.remove('border-transparent', 'text-olive-light', 'font-medium');

                // Show corresponding content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-${this.dataset.tab}`).classList.remove('hidden');
            });
        });

        // Initialize
        loadProduct();
    });
</script>
