<!-- Email Verification Page -->
<div class="min-h-[calc(100vh-200px)] flex items-center justify-center py-12 px-4 relative overflow-hidden">

    <!-- Background Decorative Elements -->
    <div class="absolute inset-0 z-0 pointer-events-none">
        <div class="absolute -top-[20%] -right-[10%] w-[40%] h-[40%] rounded-full bg-primary/5 blur-[100px]"></div>
    </div>

    <!-- Card -->
    <div
        class="w-full max-w-[520px] bg-white rounded-2xl shadow-xl border border-gray-100 relative z-10 overflow-hidden p-8 sm:p-10 text-center">

        <!-- Pending State -->
        <div id="verify-pending" class="<%= typeof verified !== 'undefined' && verified ? 'hidden' : '' %>">
            <div
                class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-amber-100 text-amber-600 mb-6">
                <span class="material-symbols-outlined text-4xl">mark_email_unread</span>
            </div>
            <h1 class="text-2xl font-bold text-olive-dark mb-3">تحقق من بريدك الإلكتروني</h1>
            <p class="text-olive-light mb-6">
                لقد أرسلنا رسالة تأكيد إلى بريدك الإلكتروني. الرجاء الضغط على الرابط في الرسالة لتفعيل حسابك.
            </p>

            <% if (typeof email !=='undefined' && email) { %>
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <p class="text-sm text-olive-light mb-1">تم الإرسال إلى:</p>
                    <p class="text-olive-dark font-medium" dir="ltr">
                        <%= email %>
                    </p>
                </div>
                <% } %>

                    <div class="space-y-4">
                        <button type="button" id="resend-btn"
                            class="w-full h-12 bg-primary hover:bg-primary-dark text-white font-bold rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-xl">send</span>
                            <span id="resend-btn-text">إعادة إرسال رسالة التأكيد</span>
                            <span id="resend-spinner" class="spinner hidden"></span>
                        </button>

                        <a href="/login"
                            class="block text-primary hover:text-accent text-sm font-medium transition-colors">
                            العودة لتسجيل الدخول
                        </a>
                    </div>

                    <!-- Resend Success Message -->
                    <div id="resend-success"
                        class="hidden mt-6 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-lg">check_circle</span>
                        <span>تم إرسال رسالة جديدة بنجاح!</span>
                    </div>

                    <!-- Resend Error Message -->
                    <div id="resend-error"
                        class="hidden mt-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-lg">error</span>
                        <span id="resend-error-message">حدث خطأ</span>
                    </div>
        </div>

        <!-- Success State -->
        <div id="verify-success" class="<%= typeof verified !== 'undefined' && verified ? '' : 'hidden' %>">
            <div
                class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-green-100 text-green-600 mb-6">
                <span class="material-symbols-outlined text-4xl">verified</span>
            </div>
            <h1 class="text-2xl font-bold text-olive-dark mb-3">تم تأكيد بريدك الإلكتروني!</h1>
            <p class="text-olive-light mb-6">
                مرحباً بك في زيتون مصر! يمكنك الآن تسجيل الدخول والبدء في التسوق.
            </p>

            <a href="/login"
                class="inline-flex items-center justify-center gap-2 h-12 px-8 bg-primary hover:bg-primary-dark text-white font-bold rounded-lg shadow-md hover:shadow-lg transition-all">
                <span>تسجيل الدخول</span>
                <span class="material-symbols-outlined text-xl rotate-rtl">login</span>
            </a>
        </div>

        <!-- Error State -->
        <div id="verify-error" class="<%= typeof error !== 'undefined' && error ? '' : 'hidden' %>">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-red-100 text-red-600 mb-6">
                <span class="material-symbols-outlined text-4xl">error</span>
            </div>
            <h1 class="text-2xl font-bold text-olive-dark mb-3">تعذر تأكيد البريد الإلكتروني</h1>
            <p class="text-olive-light mb-6">
                <%= typeof errorMessage !=='undefined' ? errorMessage
                    : 'الرابط غير صالح أو منتهي الصلاحية. حاول طلب رابط جديد.' %>
            </p>

            <div class="space-y-4">
                <button type="button" id="resend-btn-error"
                    class="w-full h-12 bg-primary hover:bg-primary-dark text-white font-bold rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-xl">send</span>
                    <span>طلب رابط جديد</span>
                </button>

                <a href="/register" class="block text-primary hover:text-accent text-sm font-medium transition-colors">
                    إنشاء حساب جديد
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const resendBtn = document.getElementById('resend-btn');
        const resendBtnError = document.getElementById('resend-btn-error');
        const resendBtnText = document.getElementById('resend-btn-text');
        const resendSpinner = document.getElementById('resend-spinner');
        const resendSuccess = document.getElementById('resend-success');
        const resendError = document.getElementById('resend-error');
        const resendErrorMessage = document.getElementById('resend-error-message');

        // Get email from URL
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email') || '';

        async function resendVerification() {
            if (!email) {
                resendError.classList.remove('hidden');
                resendErrorMessage.textContent = 'البريد الإلكتروني غير متوفر';
                return;
            }

            // Hide previous messages
            resendSuccess.classList.add('hidden');
            resendError.classList.add('hidden');

            // Show loading
            if (resendBtn) {
                resendBtn.disabled = true;
                resendBtnText.textContent = 'جاري الإرسال...';
                resendSpinner?.classList.remove('hidden');
            }

            try {
                const response = await fetch('/api/auth/resend-verification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    resendSuccess.classList.remove('hidden');
                } else {
                    resendError.classList.remove('hidden');
                    resendErrorMessage.textContent = data.message || 'حدث خطأ أثناء الإرسال';
                }
            } catch (error) {
                console.error('Resend error:', error);
                resendError.classList.remove('hidden');
                resendErrorMessage.textContent = 'حدث خطأ في الاتصال';
            } finally {
                if (resendBtn) {
                    resendBtn.disabled = false;
                    resendBtnText.textContent = 'إعادة إرسال رسالة التأكيد';
                    resendSpinner?.classList.add('hidden');
                }
            }
        }

        resendBtn?.addEventListener('click', resendVerification);
        resendBtnError?.addEventListener('click', resendVerification);
    });
</script>