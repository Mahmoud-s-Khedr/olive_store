<!-- Reset Password Page -->
<div class="min-h-[calc(100vh-200px)] flex items-center justify-center py-12 px-4 relative overflow-hidden">

    <!-- Background Decorative Elements -->
    <div class="absolute inset-0 z-0 pointer-events-none">
        <div class="absolute -top-[20%] -right-[10%] w-[40%] h-[40%] rounded-full bg-primary/5 blur-[100px]"></div>
    </div>

    <!-- Card -->
    <div
        class="w-full max-w-[480px] bg-white rounded-2xl shadow-xl border border-gray-100 relative z-10 overflow-hidden">

        <!-- Card Header -->
        <div class="pt-10 pb-6 px-8 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 text-primary mb-4">
                <span class="material-symbols-outlined text-3xl">password</span>
            </div>
            <h1 class="text-2xl font-bold text-olive-dark mb-2">إعادة تعيين كلمة المرور</h1>
            <p class="text-olive-light text-sm">أدخل كلمة المرور الجديدة</p>
        </div>

        <!-- Form -->
        <form id="reset-form" class="px-8 pb-10 flex flex-col gap-6">

            <!-- Hidden Token -->
            <input type="hidden" id="token" name="token" value="<%= typeof token !== 'undefined' ? token : '' %>">

            <!-- Error Alert -->
            <div id="reset-error"
                class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm flex items-center gap-2">
                <span class="material-symbols-outlined text-lg">error</span>
                <span id="reset-error-message">حدث خطأ</span>
            </div>

            <!-- Success Alert -->
            <div id="reset-success"
                class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm">
                <div class="flex items-center gap-2 mb-2">
                    <span class="material-symbols-outlined text-lg">check_circle</span>
                    <span class="font-medium">تم تغيير كلمة المرور بنجاح!</span>
                </div>
                <p class="text-xs">يمكنك الآن تسجيل الدخول بكلمة المرور الجديدة.</p>
            </div>

            <!-- New Password Field -->
            <div class="space-y-2">
                <label for="password" class="text-sm font-medium text-olive-dark block">كلمة المرور الجديدة</label>
                <div class="relative group">
                    <div
                        class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-olive-light group-focus-within:text-primary transition-colors">
                        <span class="material-symbols-outlined text-xl">lock</span>
                    </div>
                    <input type="password" id="password" name="password" required minlength="8" placeholder="••••••••"
                        class="block w-full h-12 pr-12 pl-12 rounded-lg border-gray-200 bg-white text-olive-dark placeholder:text-olive-light focus:border-primary focus:ring-1 focus:ring-primary transition-all text-base">
                    <button type="button" id="toggle-password"
                        class="absolute inset-y-0 left-0 pl-4 flex items-center text-olive-light hover:text-olive-dark cursor-pointer">
                        <span class="material-symbols-outlined text-xl" id="password-icon">visibility</span>
                    </button>
                </div>

                <!-- Password Strength Indicator -->
                <div id="password-strength" class="mt-3 grid grid-cols-4 gap-2 h-1.5">
                    <div class="password-strength-bar h-full rounded-full bg-gray-200"></div>
                    <div class="password-strength-bar h-full rounded-full bg-gray-200"></div>
                    <div class="password-strength-bar h-full rounded-full bg-gray-200"></div>
                    <div class="password-strength-bar h-full rounded-full bg-gray-200"></div>
                </div>
                <p id="password-strength-text" class="mt-1 text-xs text-olive-light">أدخل كلمة مرور قوية</p>
            </div>

            <!-- Confirm Password Field -->
            <div class="space-y-2">
                <label for="confirm-password" class="text-sm font-medium text-olive-dark block">تأكيد كلمة
                    المرور</label>
                <div class="relative group">
                    <div
                        class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-olive-light group-focus-within:text-primary transition-colors">
                        <span class="material-symbols-outlined text-xl">lock</span>
                    </div>
                    <input type="password" id="confirm-password" name="confirmPassword" required placeholder="••••••••"
                        class="block w-full h-12 pr-12 pl-4 rounded-lg border-gray-200 bg-white text-olive-dark placeholder:text-olive-light focus:border-primary focus:ring-1 focus:ring-primary transition-all text-base">
                </div>
                <p id="confirm-password-error" class="mt-1 text-sm text-red-600 hidden">كلمتا المرور غير متطابقتين</p>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="reset-btn"
                class="w-full h-12 bg-primary hover:bg-primary-dark text-white font-bold rounded-lg shadow-md hover:shadow-lg transition-all transform active:scale-[0.99] flex items-center justify-center gap-2">
                <span id="reset-btn-text">حفظ كلمة المرور الجديدة</span>
                <span id="reset-spinner" class="spinner hidden"></span>
            </button>

            <!-- Login Link -->
            <div class="text-center">
                <a href="/login" class="text-primary hover:text-accent text-sm font-medium transition-colors">
                    العودة لتسجيل الدخول
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('reset-form');
        const tokenInput = document.getElementById('token');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const togglePassword = document.getElementById('toggle-password');
        const passwordIcon = document.getElementById('password-icon');
        const strengthBars = document.querySelectorAll('.password-strength-bar');
        const strengthText = document.getElementById('password-strength-text');
        const confirmError = document.getElementById('confirm-password-error');
        const resetBtn = document.getElementById('reset-btn');
        const resetBtnText = document.getElementById('reset-btn-text');
        const resetSpinner = document.getElementById('reset-spinner');
        const resetError = document.getElementById('reset-error');
        const resetErrorMessage = document.getElementById('reset-error-message');
        const resetSuccess = document.getElementById('reset-success');

        // Get token from URL if not set
        if (!tokenInput.value) {
            const urlParams = new URLSearchParams(window.location.search);
            tokenInput.value = urlParams.get('token') || '';
        }

        // Toggle password visibility
        togglePassword?.addEventListener('click', function () {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            confirmPasswordInput.setAttribute('type', type);
            passwordIcon.textContent = type === 'password' ? 'visibility' : 'visibility_off';
        });

        // Password strength checker
        function checkPasswordStrength(password) {
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/)) strength++;
            if (password.match(/[^a-zA-Z0-9]/)) strength++;
            return strength;
        }

        passwordInput?.addEventListener('input', function () {
            const strength = checkPasswordStrength(this.value);
            const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500'];
            const texts = ['ضعيفة جداً', 'ضعيفة', 'متوسطة', 'قوية'];

            strengthBars.forEach((bar, index) => {
                bar.classList.remove('bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500');
                if (index < strength) {
                    bar.classList.add(colors[strength - 1]);
                } else {
                    bar.classList.add('bg-gray-200');
                }
            });

            if (this.value.length > 0) {
                strengthText.textContent = 'قوة كلمة المرور: ' + (texts[strength - 1] || 'ضعيفة جداً');
            } else {
                strengthText.textContent = 'أدخل كلمة مرور قوية';
            }
        });

        // Check password match
        confirmPasswordInput?.addEventListener('input', function () {
            if (passwordInput.value !== this.value && this.value.length > 0) {
                confirmError.classList.remove('hidden');
                this.classList.add('border-red-300');
            } else {
                confirmError.classList.add('hidden');
                this.classList.remove('border-red-300');
            }
        });

        form?.addEventListener('submit', async function (e) {
            e.preventDefault();

            // Validate passwords match
            if (passwordInput.value !== confirmPasswordInput.value) {
                resetError.classList.remove('hidden');
                resetErrorMessage.textContent = 'كلمتا المرور غير متطابقتين';
                return;
            }

            // Hide previous messages
            resetError.classList.add('hidden');
            resetSuccess.classList.add('hidden');

            // Show loading state
            resetBtn.disabled = true;
            resetBtnText.textContent = 'جاري الحفظ...';
            resetSpinner.classList.remove('hidden');

            try {
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: tokenInput.value,
                        password: passwordInput.value
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show success message
                    resetSuccess.classList.remove('hidden');
                    form.querySelectorAll('input').forEach(input => input.disabled = true);
                    resetBtn.classList.add('hidden');

                    // Redirect to login after delay
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 3000);
                } else {
                    // Show error
                    resetError.classList.remove('hidden');
                    resetErrorMessage.textContent = data.message || 'حدث خطأ أثناء إعادة تعيين كلمة المرور';
                }
            } catch (error) {
                console.error('Reset password error:', error);
                resetError.classList.remove('hidden');
                resetErrorMessage.textContent = 'حدث خطأ في الاتصال. حاول مرة أخرى.';
            } finally {
                // Reset button state
                resetBtn.disabled = false;
                resetBtnText.textContent = 'حفظ كلمة المرور الجديدة';
                resetSpinner.classList.add('hidden');
            }
        });
    });
</script>