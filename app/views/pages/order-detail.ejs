<!-- Order Detail Page -->
<div class="max-w-[1000px] mx-auto px-4 py-8">

    <!-- Breadcrumbs -->
    <nav class="flex items-center gap-2 text-sm text-olive-light mb-6">
        <a href="/" class="hover:text-primary transition-colors">الرئيسية</a>
        <span class="text-gray-300">/</span>
        <a href="/my-orders" class="hover:text-primary transition-colors">طلباتي</a>
        <span class="text-gray-300">/</span>
        <span id="breadcrumb-order" class="text-olive-dark font-medium">تفاصيل الطلب</span>
    </nav>

    <!-- Loading State -->
    <div id="loading-state">
        <div class="skeleton h-20 rounded-xl mb-6"></div>
        <div class="skeleton h-64 rounded-xl mb-6"></div>
        <div class="skeleton h-48 rounded-xl"></div>
    </div>

    <!-- Not Found State -->
    <div id="not-found" class="hidden text-center py-20">
        <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-6">
            <span class="material-symbols-outlined text-5xl text-olive-light">search_off</span>
        </div>
        <h2 class="text-xl font-bold text-olive-dark mb-2">الطلب غير موجود</h2>
        <p class="text-olive-light mb-6">لم نتمكن من العثور على هذا الطلب</p>
        <a href="/my-orders"
            class="inline-flex items-center gap-2 bg-primary hover:bg-primary-dark text-white px-8 py-3 rounded-lg font-bold transition-all">
            <span class="material-symbols-outlined">arrow_forward</span>
            العودة للطلبات
        </a>
    </div>

    <!-- Order Content -->
    <div id="order-content" class="hidden">

        <!-- Order Header -->
        <div class="bg-white rounded-xl border border-gray-100 p-6 mb-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <h1 id="order-title" class="text-2xl font-bold text-olive-dark">طلب #---</h1>
                        <span id="order-status"
                            class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-amber-100 text-amber-800 text-xs font-bold">
                            <span class="w-2 h-2 rounded-full bg-amber-500"></span>
                            قيد الانتظار
                        </span>
                    </div>
                    <p id="order-date" class="text-olive-light text-sm">تاريخ الطلب: ---</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="window.print()"
                        class="flex items-center gap-2 h-10 px-4 border border-gray-200 rounded-lg text-olive-dark hover:bg-gray-50 transition-colors text-sm font-medium">
                        <span class="material-symbols-outlined text-lg">print</span>
                        طباعة
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Order Items -->
                <div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                        <h2 class="font-bold text-olive-dark">المنتجات</h2>
                    </div>
                    <div id="order-items" class="divide-y divide-gray-100">
                        <!-- Items loaded dynamically -->
                    </div>
                </div>

                <!-- Order Timeline -->
                <div class="bg-white rounded-xl border border-gray-100 p-6">
                    <h2 class="font-bold text-olive-dark mb-6">تتبع الطلب</h2>
                    <div id="order-timeline" class="space-y-6">
                        <!-- Timeline loaded dynamically -->
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Order Summary -->
                <div class="bg-white rounded-xl border border-gray-100 p-6">
                    <h2 class="font-bold text-olive-dark mb-4">ملخص الطلب</h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-olive-light">المجموع الفرعي</span>
                            <span id="subtotal" class="text-olive-dark font-medium">---</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-olive-light">الشحن</span>
                            <span id="shipping" class="text-olive-dark font-medium">---</span>
                        </div>
                        <div id="discount-row" class="flex justify-between hidden">
                            <span class="text-olive-light">الخصم</span>
                            <span id="discount" class="text-green-600 font-medium">---</span>
                        </div>
                        <hr class="border-gray-100">
                        <div class="flex justify-between text-base">
                            <span class="font-bold text-olive-dark">الإجمالي</span>
                            <span id="total" class="font-bold text-primary">---</span>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="bg-white rounded-xl border border-gray-100 p-6">
                    <h2 class="font-bold text-olive-dark mb-4">طريقة الدفع</h2>
                    <div id="payment-method" class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-2xl">local_shipping</span>
                        <span class="text-olive-dark">الدفع عند الاستلام</span>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="bg-white rounded-xl border border-gray-100 p-6">
                    <h2 class="font-bold text-olive-dark mb-4">عنوان الشحن</h2>
                    <div id="shipping-address" class="text-olive-dark text-sm space-y-1">
                        <!-- Address loaded dynamically -->
                    </div>
                </div>

                <!-- Need Help -->
                <div class="bg-primary/5 rounded-xl p-6">
                    <h3 class="font-bold text-olive-dark mb-2">تحتاج مساعدة؟</h3>
                    <p class="text-sm text-olive-light mb-4">تواصل معنا إذا كنت بحاجة لأي استفسار.</p>
                    <a href="/contact"
                        class="inline-flex items-center gap-2 text-primary font-medium text-sm hover:underline">
                        <span class="material-symbols-outlined text-lg">support_agent</span>
                        تواصل مع الدعم
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const token = localStorage.getItem('token');

        // Redirect if not logged in
        if (!token) {
            window.location.href = '/login?redirect=' + window.location.pathname;
            return;
        }

        // Get order ID from URL
        const pathParts = window.location.pathname.split('/');
        const orderNumber = pathParts[pathParts.length - 1];

        // Convert to Arabic numerals
        function toArabicNum(num) {
            const arabicNums = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return String(num).split('').map(d => arabicNums[parseInt(d)] || d).join('');
        }

        // Format price
        function formatPrice(price) {
            return toArabicNum(parseFloat(price).toFixed(0)) + ' ج.م';
        }

        // Format date
        function formatDate(dateStr) {
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateStr).toLocaleDateString('ar-EG', options);
        }

        // Get status info
        function getStatusInfo(status) {
            const statuses = {
                'pending': { label: 'قيد الانتظار', class: 'bg-amber-100 text-amber-800', dot: 'bg-amber-500', icon: 'schedule' },
                'processing': { label: 'جاري التجهيز', class: 'bg-blue-100 text-blue-800', dot: 'bg-blue-500', icon: 'inventory_2' },
                'shipped': { label: 'تم الشحن', class: 'bg-purple-100 text-purple-800', dot: 'bg-purple-500', icon: 'local_shipping' },
                'delivered': { label: 'تم التوصيل', class: 'bg-green-100 text-green-800', dot: 'bg-green-500', icon: 'check_circle' },
                'cancelled': { label: 'ملغي', class: 'bg-red-100 text-red-800', dot: 'bg-red-500', icon: 'cancel' }
            };
            return statuses[status] || statuses['pending'];
        }

        // Load order
        async function loadOrder() {
            const loadingState = document.getElementById('loading-state');
            const notFound = document.getElementById('not-found');
            const orderContent = document.getElementById('order-content');

            try {
            const response = await fetch(`/api/orders/${orderNumber}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/login?redirect=' + window.location.pathname;
                    return;
                }

                if (!response.ok) {
                    loadingState.classList.add('hidden');
                    notFound.classList.remove('hidden');
                    return;
                }

                const data = await response.json();
                const order = data.order || data;
                const items = data.items || order.items || [];

                loadingState.classList.add('hidden');
                orderContent.classList.remove('hidden');

                // Populate order info
                document.getElementById('breadcrumb-order').textContent = `طلب #${order.order_number || order.id}`;
                document.getElementById('order-title').textContent = `طلب #${order.order_number || order.id}`;
                document.getElementById('order-date').textContent = `تاريخ الطلب: ${formatDate(order.created_at)}`;

                // Status badge
                const statusInfo = getStatusInfo(order.status);
                document.getElementById('order-status').innerHTML = `
                <span class="w-2 h-2 rounded-full ${statusInfo.dot}"></span>
                ${statusInfo.label}
            `;
                document.getElementById('order-status').className = `inline-flex items-center gap-1.5 px-3 py-1 rounded-full ${statusInfo.class} text-xs font-bold`;

                // Order items
                const itemsContainer = document.getElementById('order-items');
                if (items.length > 0) {
                    itemsContainer.innerHTML = items.map(item => `
                    <div class="flex items-center gap-4 p-4">
                        <div class="w-16 h-16 rounded-lg bg-gray-50 overflow-hidden flex-shrink-0">
                            ${item.product_image ?
                            `<img src="${item.product_image}" alt="${item.product_name_ar || item.product_name_en || 'منتج'}" class="w-full h-full object-cover">` :
                            `<div class="w-full h-full flex items-center justify-center text-olive-light">
                                    <span class="material-symbols-outlined text-2xl">inventory_2</span>
                                </div>`
                        }
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-olive-dark truncate">${item.product_name_ar || item.product_name_en || 'منتج'}</h4>
                            <p class="text-sm text-olive-light">الكمية: ${toArabicNum(item.quantity)}</p>
                        </div>
                        <div class="text-left">
                            <p class="font-bold text-primary">${formatPrice(item.price * item.quantity)}</p>
                            <p class="text-xs text-olive-light">${formatPrice(item.price)} × ${toArabicNum(item.quantity)}</p>
                        </div>
                    </div>
                `).join('');
                } else {
                    itemsContainer.innerHTML = '<p class="p-4 text-olive-light text-center">لا توجد منتجات</p>';
                }

                // Order summary
                const subtotal = order.subtotal || (order.total - (order.shipping_cost || 0));
                document.getElementById('subtotal').textContent = formatPrice(subtotal);
                document.getElementById('shipping').textContent = formatPrice(order.shipping_cost || 0);
                document.getElementById('total').textContent = formatPrice(order.total);

                if (order.discount && order.discount > 0) {
                    document.getElementById('discount-row').classList.remove('hidden');
                    document.getElementById('discount').textContent = '-' + formatPrice(order.discount);
                }

                // Payment method
                const paymentMethods = {
                    'cod': { icon: 'local_shipping', label: 'الدفع عند الاستلام' },
                    'card': { icon: 'credit_card', label: 'بطاقة ائتمان' }
                };
                const pm = paymentMethods[order.payment_method] || paymentMethods['cod'];
                document.getElementById('payment-method').innerHTML = `
                <span class="material-symbols-outlined text-primary text-2xl">${pm.icon}</span>
                <span class="text-olive-dark">${pm.label}</span>
            `;

                // Shipping address
                const address = order.shipping_address || {
                    name: order.customer_name,
                    address: order.address,
                    city: order.city,
                    governorate: order.governorate,
                    phone: order.phone
                };
                const cityLine = [address.city, address.governorate].filter(Boolean).join(', ');
                document.getElementById('shipping-address').innerHTML = `
                <p class="font-medium">${address.name || ''}</p>
                <p>${address.address || ''}</p>
                <p>${cityLine}</p>
                <p dir="ltr" class="text-olive-light">${address.phone || ''}</p>
            `;

                // Timeline
                const timeline = document.getElementById('order-timeline');
                const timelineSteps = [
                    { status: 'pending', title: 'تم استلام الطلب', icon: 'check_circle' },
                    { status: 'processing', title: 'جاري التجهيز', icon: 'inventory_2' },
                    { status: 'shipped', title: 'تم الشحن', icon: 'local_shipping' },
                    { status: 'delivered', title: 'تم التوصيل', icon: 'check_circle' }
                ];

                const statusOrder = ['pending', 'processing', 'shipped', 'delivered'];
                const currentIndex = statusOrder.indexOf(order.status);

                timeline.innerHTML = timelineSteps.map((step, index) => {
                    const isActive = index <= currentIndex && order.status !== 'cancelled';
                    const isCurrent = index === currentIndex;

                    return `
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full ${isActive ? 'bg-primary text-white' : 'bg-gray-100 text-olive-light'} flex items-center justify-center">
                                <span class="material-symbols-outlined">${isActive ? 'check' : step.icon}</span>
                            </div>
                            ${index < timelineSteps.length - 1 ? `<div class="w-0.5 h-full ${isActive ? 'bg-primary' : 'bg-gray-200'} my-2"></div>` : ''}
                        </div>
                        <div class="pb-6">
                            <h4 class="font-medium ${isActive ? 'text-olive-dark' : 'text-olive-light'}">${step.title}</h4>
                            ${isCurrent && order.updated_at ? `<p class="text-xs text-olive-light mt-1">${formatDate(order.updated_at)}</p>` : ''}
                        </div>
                    </div>
                `;
                }).join('');

            } catch (error) {
                console.error('Error loading order:', error);
                loadingState.classList.add('hidden');
                notFound.classList.remove('hidden');
            }
        }

        // Initialize
        loadOrder();
    });
</script>
